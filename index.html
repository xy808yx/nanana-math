<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Fun math practice for kids. Master addition, subtraction, multiplication, and more with Pomodoro-style focused sessions.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nanana Math">
    <meta name="theme-color" content="#1a0a2e">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Nanana Math</title>
    <style>
        :root {
            --bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --primary: #ffd93d;
            --accent: #ff6b9d;
            --success: #6bcb77;
            --error: #ff6b6b;
            --card-bg: rgba(255, 255, 255, 0.05);
            --text: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.6);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            height: -webkit-fill-available;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100%;
            min-height: -webkit-fill-available;
            padding: 15px;
            padding-top: max(15px, env(safe-area-inset-top));
            padding-bottom: max(15px, env(safe-area-inset-bottom));
        }

        /* Screens */
        .screen {
            display: none;
            width: 100%;
            max-width: 400px;
            flex-direction: column;
            gap: 20px;
        }
        .screen.active { display: flex; }

        /* Profile Selection Screen */
        .app-title {
            font-size: 2.5rem;
            font-weight: 800;
            text-align: center;
            color: var(--primary);
            text-shadow: 0 0 30px var(--primary);
            margin-bottom: 10px;
        }
        .app-subtitle {
            text-align: center;
            color: var(--text-dim);
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .profiles-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .profile-card {
            background: var(--card-bg);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .profile-card:hover, .profile-card:active {
            border-color: var(--primary);
            transform: scale(1.02);
            background: rgba(255, 215, 61, 0.1);
        }
        .profile-card.add-new {
            border-style: dashed;
            opacity: 0.6;
        }
        .profile-card.add-new:hover {
            opacity: 1;
            border-color: var(--accent);
        }

        .profile-avatar {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        .profile-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .profile-level {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        /* Practice Screen */
        .practice-container {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .practice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .player-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .player-avatar { font-size: 2rem; }
        .player-name { font-weight: 600; font-size: 1.1rem; }
        .player-tier { font-size: 0.8rem; color: var(--primary); }

        .back-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        /* Progress Section */
        .tier-progress {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .tier-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .tier-name { color: var(--primary); font-weight: 600; }
        .tier-count { color: var(--text-dim); }

        .tier-bar {
            height: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            overflow: hidden;
        }
        .tier-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        /* Pomodoro Timer */
        .pomodoro-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: rgba(255, 215, 61, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .pomodoro-timer {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .pomodoro-time {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            font-variant-numeric: tabular-nums;
        }
        .pomodoro-time.warning { color: var(--accent); }
        .pomodoro-time.danger { color: var(--error); animation: pulse 1s infinite; }
        .pomodoro-label {
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .mastery-tracker {
            font-size: 1.1rem;
            color: var(--text);
        }
        .mastery-progress {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Break Screen */
        .break-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            display: none;
        }
        .break-overlay.active { display: flex; }
        .break-emoji { font-size: 4rem; margin-bottom: 20px; }
        .break-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }
        .break-subtitle {
            color: var(--text-dim);
            margin-bottom: 30px;
        }
        .break-timer {
            font-size: 4rem;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 30px;
            font-variant-numeric: tabular-nums;
        }
        .break-stats {
            background: var(--card-bg);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        .break-stat-row {
            display: flex;
            gap: 30px;
            justify-content: center;
        }
        .break-stat {
            text-align: center;
        }
        .break-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        .break-stat-label {
            font-size: 0.8rem;
            color: var(--text-dim);
        }
        .break-buttons {
            display: flex;
            gap: 15px;
        }
        .break-btn {
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }
        .break-btn.primary {
            background: var(--primary);
            color: #000;
        }
        .break-btn.secondary {
            background: var(--card-bg);
            color: var(--text);
            border: 2px solid var(--text-dim);
        }

        /* Audio Controls */
        .audio-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .audio-btn {
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            font-size: 1.3rem;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.2s;
        }
        .audio-btn.active {
            opacity: 1;
            border-color: var(--primary);
            background: rgba(255, 215, 61, 0.2);
        }

        /* Problem Area */
        .problem-area {
            text-align: center;
            padding: 20px;
        }

        /* Counting Dots */
        .dots-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            min-height: 50px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .dot-group {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            max-width: 120px;
        }
        .dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            box-shadow: 0 0 8px var(--primary);
        }
        .dot.second {
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }
        .dots-operator {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-dim);
        }
        .dots-equals {
            font-size: 1.5rem;
            color: var(--text-dim);
        }
        .dots-result {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dim);
            min-width: 30px;
        }

        .problem {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 20px;
            letter-spacing: 4px;
        }
        .answer-box {
            font-size: 2.5rem;
            font-weight: 600;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 15px 30px;
            min-width: 120px;
            display: inline-block;
            min-height: 70px;
        }
        .answer-box.correct {
            border-color: var(--success);
            background: rgba(107, 203, 119, 0.2);
        }
        .answer-box.wrong {
            border-color: var(--error);
            background: rgba(255, 107, 107, 0.2);
        }

        .feedback {
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            margin-top: 15px;
        }
        .feedback.correct { color: var(--success); }
        .feedback.wrong { color: var(--error); }
        .correct-answer {
            font-weight: 600;
            font-size: 1.2rem;
        }

        /* Numpad */
        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .numpad button {
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            font-size: 1.8rem;
            font-weight: 600;
            padding: 18px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        .numpad button:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.1);
        }
        .numpad .go-btn {
            background: var(--success);
            color: #000;
        }
        .numpad .go-btn:active {
            background: #5ab868;
        }

        /* Session Complete Screen */
        .session-complete {
            text-align: center;
        }
        .session-emoji {
            font-size: 4rem;
            margin-bottom: 15px;
        }
        .session-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 25px;
        }

        .session-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-box {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px 15px;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-top: 5px;
        }

        .mastered-section {
            background: rgba(107, 203, 119, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .mastered-title {
            color: var(--success);
            font-weight: 600;
            margin-bottom: 10px;
        }
        .mastered-facts {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .mastered-fact {
            background: var(--success);
            color: #000;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .practice-section {
            background: rgba(255, 215, 61, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .practice-title {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 10px;
        }
        .practice-facts {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .practice-fact {
            background: rgba(255, 215, 61, 0.3);
            color: var(--text);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .done-btn {
            background: var(--primary);
            color: #000;
            border: none;
            font-size: 1.2rem;
            font-weight: 700;
            padding: 18px 50px;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .done-btn:active {
            transform: scale(0.97);
        }

        /* Session buttons */
        .session-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .continue-btn {
            background: var(--success);
            color: #000;
            border: none;
            font-size: 1.2rem;
            font-weight: 700;
            padding: 18px 50px;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .continue-btn:active {
            transform: scale(0.97);
        }

        /* Day Streak */
        .streak-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 12px 20px;
            background: rgba(255, 107, 107, 0.15);
            border-radius: 25px;
        }
        .streak-fire { font-size: 1.5rem; }
        .streak-count {
            font-size: 1.8rem;
            font-weight: 800;
            color: #ff6b6b;
        }
        .streak-label {
            font-size: 1rem;
            color: var(--text-dim);
        }

        /* Profile card streak */
        .profile-streak {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #ff6b6b;
        }

        /* Parent View */
        .parent-view {
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .parent-player {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .parent-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .parent-stat {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        .parent-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        .parent-stat-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 4px;
        }
        .parent-struggles {
            background: rgba(255, 107, 107, 0.1);
            border-radius: 15px;
            padding: 15px;
        }
        .parent-struggles-title {
            color: var(--error);
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .struggle-fact {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem;
        }
        .struggle-fact:last-child { border-bottom: none; }
        .struggle-rate { color: var(--error); font-weight: 600; }

        /* Parent button on profile card */
        .parent-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            opacity: 0.4;
            padding: 5px;
        }
        .parent-btn:hover { opacity: 1; }
        .profile-card { position: relative; }

        /* Add Profile Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 100;
        }
        .modal.active { display: flex; }

        .modal-content {
            background: #1a1a2e;
            border-radius: 25px;
            padding: 30px;
            width: 100%;
            max-width: 350px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 25px;
        }

        .avatar-picker {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }
        .avatar-option {
            font-size: 2.5rem;
            padding: 10px;
            border: 3px solid transparent;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        .avatar-option.selected {
            border-color: var(--primary);
            background: rgba(255, 215, 61, 0.2);
        }
        .avatar-option.locked {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
        .avatar-option.locked:hover {
            transform: none;
        }

        .name-input {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 1.2rem;
            color: var(--text);
            text-align: center;
            margin-bottom: 25px;
        }
        .name-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .name-input::placeholder {
            color: var(--text-dim);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
        }
        .modal-btn {
            flex: 1;
            padding: 15px;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        .modal-btn.cancel {
            background: rgba(255,255,255,0.1);
            color: var(--text);
        }
        .modal-btn.confirm {
            background: var(--primary);
            color: #000;
        }

        /* Tier unlock celebration */
        .tier-unlock {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 200;
            flex-direction: column;
            gap: 20px;
            text-align: center;
            padding: 20px;
        }
        .tier-unlock.active { display: flex; }
        .tier-unlock-emoji { font-size: 5rem; }
        .tier-unlock-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 700;
        }
        .tier-unlock-name {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text);
        }
    </style>
</head>
<body>

    <!-- Profile Selection Screen -->
    <div class="screen active" id="profileScreen">
        <div class="app-title">Nanana Math</div>
        <div class="app-subtitle">Build strong math foundations</div>
        <div class="profiles-grid" id="profilesGrid"></div>
    </div>

    <!-- Practice Screen -->
    <div class="screen" id="practiceScreen">
        <div class="practice-container">
            <div class="practice-header">
                <div class="player-info">
                    <div class="player-avatar" id="currentAvatar">ü¶ä</div>
                    <div>
                        <div class="player-name" id="currentName">Player</div>
                        <div class="player-tier" id="currentTier">Addition to 5</div>
                    </div>
                </div>
                <button class="back-btn" onclick="endPracticeSession()">‚úï</button>
            </div>

            <div class="tier-progress">
                <div class="tier-label">
                    <span class="tier-name" id="tierName">Addition to 5</span>
                    <span class="tier-count" id="tierCount">0/10 mastered</span>
                </div>
                <div class="tier-bar">
                    <div class="tier-fill" id="tierFill" style="width: 0%"></div>
                </div>
            </div>

            <div class="pomodoro-section" id="pomodoroSection">
                <div class="pomodoro-timer">
                    <span class="pomodoro-time" id="pomodoroTime">25:00</span>
                    <span class="pomodoro-label">remaining</span>
                </div>
                <div class="mastery-tracker">
                    <span class="mastery-progress" id="masteryProgress">0</span>/<span id="masteryGoalDisplay">5</span> ‚≠ê mastered
                </div>
            </div>

            <div class="audio-controls">
                <button class="audio-btn active" id="soundBtn" onclick="toggleSound()" title="Sound effects">üîä</button>
                <button class="audio-btn active" id="speakBtn" onclick="toggleSpeak()" title="Read aloud">üó£Ô∏è</button>
                <button class="audio-btn active" id="dotsBtn" onclick="toggleDots()" title="Show counting dots">üëÅÔ∏è</button>
            </div>

            <div class="problem-area">
                <div class="timer-bar" id="timerBar" style="display:none;">
                    <div class="timer-fill" id="timerFill" style="width:100%"></div>
                </div>
                <div class="dots-container" id="dotsContainer"></div>
                <div class="clock-container" id="clockContainer" style="display:none;"></div>
                <div class="problem-hint" id="problemHint" style="display:none;font-size:0.9rem;color:var(--text-dim);margin-bottom:5px;"></div>
                <div class="problem" id="problem">3 + 2</div>
                <div class="answer-box" id="answerBox">|</div>
                <div class="feedback" id="feedback"></div>
                <button class="hint-btn" id="hintBtn" style="display:none;" onclick="showHint()">üí° Need a hint?</button>
                <div class="hint-text" id="hintText" style="display:none;"></div>
            </div>

            <div class="numpad">
                <button onclick="numPress(1)">1</button>
                <button onclick="numPress(2)">2</button>
                <button onclick="numPress(3)">3</button>
                <button onclick="numPress(4)">4</button>
                <button onclick="numPress(5)">5</button>
                <button onclick="numPress(6)">6</button>
                <button onclick="numPress(7)">7</button>
                <button onclick="numPress(8)">8</button>
                <button onclick="numPress(9)">9</button>
                <button onclick="clearInput()">‚Üê</button>
                <button onclick="numPress(0)">0</button>
                <button class="go-btn" onclick="checkAnswer()">GO</button>
            </div>
        </div>
    </div>

    <!-- Session Complete Screen -->
    <div class="screen" id="sessionScreen">
        <div class="practice-container session-complete">
            <div class="session-emoji">üåü</div>
            <div class="session-title">Great Practice!</div>

            <div class="streak-display" id="streakDisplay">
                <span class="streak-fire">üî•</span>
                <span class="streak-count" id="streakCount">1</span>
                <span class="streak-label" id="streakLabel">day streak!</span>
            </div>

            <div class="session-stats">
                <div class="stat-box">
                    <div class="stat-value" id="sessionCorrect">0</div>
                    <div class="stat-label">Correct</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="sessionAccuracy">0%</div>
                    <div class="stat-label" id="sessionAccuracyLabel">Accuracy</div>
                </div>
            </div>

            <div class="mastered-section" id="masteredSection" style="display:none;">
                <div class="mastered-title">‚≠ê Newly Mastered!</div>
                <div class="mastered-facts" id="masteredFacts"></div>
            </div>

            <div class="practice-section" id="practiceMoreSection" style="display:none;">
                <div class="practice-title">üìù Keep Practicing</div>
                <div class="practice-facts" id="practiceFacts"></div>
            </div>

            <div class="session-buttons">
                <button class="done-btn" onclick="finishSession()">Done</button>
            </div>
        </div>
    </div>

    <!-- Parent View Modal -->
    <div class="modal" id="parentModal">
        <div class="modal-content parent-view">
            <div class="modal-title">üìä Progress Report</div>
            <div class="parent-player" id="parentPlayerName"></div>
            <div class="parent-stats" id="parentStats"></div>
            <div class="parent-struggles" id="parentStruggles"></div>
            <button class="modal-btn confirm" onclick="closeParentView()" style="width:100%;margin-top:20px;">Close</button>
        </div>
    </div>

    <!-- Add Profile Modal -->
    <div class="modal" id="addProfileModal">
        <div class="modal-content">
            <div class="modal-title">New Player</div>
            <div class="avatar-picker" id="avatarPicker"></div>
            <input type="text" class="name-input" id="nameInput" placeholder="Enter name" maxlength="12">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeAddProfile()">Cancel</button>
                <button class="modal-btn confirm" onclick="saveNewProfile()">Create</button>
            </div>
        </div>
    </div>

    <!-- Tier Unlock Celebration -->
    <div class="tier-unlock" id="tierUnlock">
        <div class="tier-unlock-emoji">üéâ</div>
        <div class="tier-unlock-title">NEW SKILL UNLOCKED!</div>
        <div class="tier-unlock-name" id="tierUnlockName">Subtraction to 5</div>
    </div>

    <!-- Achievement Popup -->
    <div class="tier-unlock" id="achievementPopup">
        <div class="tier-unlock-emoji" id="achievementEmoji">üèÜ</div>
        <div class="tier-unlock-title">ACHIEVEMENT UNLOCKED!</div>
        <div class="tier-unlock-name" id="achievementName">Getting Started</div>
        <div style="font-size:0.9rem;color:var(--text-dim);margin-top:10px;" id="achievementDesc">Answer 10 problems</div>
    </div>

    <!-- Achievements Modal -->
    <div class="modal" id="achievementsModal">
        <div class="modal-content" style="max-height:80vh;overflow-y:auto;">
            <div class="modal-title">üèÜ Achievements</div>
            <div id="achievementsList" style="display:grid;gap:10px;"></div>
            <button class="modal-btn confirm" onclick="closeAchievements()" style="width:100%;margin-top:20px;">Close</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-title">‚öôÔ∏è Settings</div>
            <div style="margin-bottom:20px;">
                <label style="display:block;margin-bottom:8px;color:var(--text-dim);font-size:0.9rem;">Session Length</label>
                <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;" id="sessionLengthOptions">
                    <button class="goal-option" onclick="setSessionLength(15)">15 min</button>
                    <button class="goal-option" onclick="setSessionLength(20)">20 min</button>
                    <button class="goal-option" onclick="setSessionLength(25)">25 min</button>
                    <button class="goal-option" onclick="setSessionLength(30)">30 min</button>
                </div>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block;margin-bottom:8px;color:var(--text-dim);font-size:0.9rem;">Mastery Goal (facts per session)</label>
                <div style="display:flex;gap:8px;justify-content:center;" id="masteryGoalOptions">
                    <button class="goal-option" onclick="setMasteryGoal(3)">3</button>
                    <button class="goal-option" onclick="setMasteryGoal(5)">5</button>
                    <button class="goal-option" onclick="setMasteryGoal(10)">10</button>
                </div>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block;margin-bottom:8px;color:var(--text-dim);font-size:0.9rem;">Break Length</label>
                <div style="display:flex;gap:8px;justify-content:center;" id="breakLengthOptions">
                    <button class="goal-option" onclick="setBreakLength(5)">5 min</button>
                    <button class="goal-option" onclick="setBreakLength(10)">10 min</button>
                </div>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block;margin-bottom:8px;color:var(--text-dim);font-size:0.9rem;">Text Size</label>
                <div style="display:flex;gap:10px;justify-content:center;">
                    <button class="goal-option" onclick="setTextSize('normal')">Normal</button>
                    <button class="goal-option" onclick="setTextSize('large')">Large</button>
                </div>
            </div>
            <button class="modal-btn confirm" onclick="closeSettings()" style="width:100%;margin-top:10px;">Done</button>
        </div>
    </div>

    <!-- Review Mode Indicator -->
    <style>
        .review-badge {
            background: var(--error);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 10px;
        }
        .goal-option {
            background: var(--card-bg);
            border: 2px solid rgba(255,255,255,0.1);
            color: var(--text);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
        }
        .goal-option:hover, .goal-option.active {
            border-color: var(--primary);
            background: rgba(255, 215, 61, 0.2);
        }
        .profile-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
        }
        .profile-action-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            color: var(--text-dim);
            cursor: pointer;
        }
        .profile-action-btn:hover {
            background: rgba(255,255,255,0.2);
            color: var(--text);
        }
        .achievement-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 12px;
        }
        .achievement-item.locked {
            opacity: 0.4;
        }
        .achievement-emoji {
            font-size: 2rem;
        }
        .achievement-info {
            text-align: left;
        }
        .achievement-name {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .achievement-desc {
            font-size: 0.8rem;
            color: var(--text-dim);
        }
        body.large-text .problem { font-size: 4rem; }
        body.large-text .answer-box { font-size: 3.5rem; }
        body.large-text .numpad button { font-size: 2.2rem; }

        /* Analog Clock */
        .clock-face {
            width: 120px;
            height: 120px;
            border: 4px solid var(--primary);
            border-radius: 50%;
            position: relative;
            background: rgba(0,0,0,0.3);
            margin: 0 auto 15px;
        }
        .clock-center {
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        .clock-hand {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            border-radius: 4px;
        }
        .clock-hand.hour {
            width: 6px;
            height: 30px;
            background: var(--primary);
            margin-left: -3px;
        }
        .clock-hand.minute {
            width: 4px;
            height: 45px;
            background: var(--accent);
            margin-left: -2px;
        }
        .clock-number {
            position: absolute;
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--text-dim);
        }

        /* Coins */
        .coin {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.6rem;
            margin: 2px;
        }
        .coin.penny {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #b87333, #cd7f32);
            color: #4a3000;
        }
        .coin.nickel {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #a8a8a8, #c0c0c0);
            color: #333;
        }
        .coin.dime {
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, #c0c0c0, #d4d4d4);
            color: #333;
        }
        .coin.quarter {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            color: #333;
        }

        /* Confetti */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Timed Mode */
        .timer-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .timer-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.1s linear;
        }
        .timer-fill.warning { background: var(--primary); }
        .timer-fill.danger { background: var(--error); }
        .timed-badge {
            background: var(--accent);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 10px;
        }

        /* Hint Button */
        .hint-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 10px;
        }
        .hint-btn:hover { background: rgba(255,255,255,0.2); }
        .hint-text {
            font-size: 0.9rem;
            color: var(--accent);
            margin-top: 8px;
            font-style: italic;
        }

        /* Shake animation for wrong answers */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .answer-box.wrong {
            animation: shake 0.3s ease-in-out;
        }
    </style>

    <!-- Break Overlay -->
    <div class="break-overlay" id="breakOverlay">
        <div class="break-emoji">‚òï</div>
        <div class="break-title">Break Time!</div>
        <div class="break-subtitle">Great work! Take a breather.</div>
        <div class="break-timer" id="breakTimer">5:00</div>
        <div class="break-stats">
            <div class="break-stat-row">
                <div class="break-stat">
                    <div class="break-stat-value" id="breakCorrect">0</div>
                    <div class="break-stat-label">Correct</div>
                </div>
                <div class="break-stat">
                    <div class="break-stat-value" id="breakMastered">0</div>
                    <div class="break-stat-label">Mastered</div>
                </div>
                <div class="break-stat">
                    <div class="break-stat-value" id="breakAccuracy">0%</div>
                    <div class="break-stat-label">Accuracy</div>
                </div>
            </div>
        </div>
        <div class="break-buttons">
            <button class="break-btn primary" onclick="startNextPomodoro()">Another Round</button>
            <button class="break-btn secondary" onclick="finishPractice()">All Done</button>
        </div>
    </div>

    <!-- Confetti Container -->
    <div class="confetti-container" id="confettiContainer"></div>

    <script>
        // ============================================
        // SKILL TIERS - Progression System
        // ============================================
        const TIERS = [
            {
                id: 'add5',
                name: 'Addition to 5',
                facts: generateAdditionFacts(5),
                requiredMastery: 0.9
            },
            {
                id: 'add10',
                name: 'Addition to 10',
                facts: generateAdditionFacts(10),
                requiredMastery: 0.9
            },
            {
                id: 'sub5',
                name: 'Subtraction to 5',
                facts: generateSubtractionFacts(5),
                requiredMastery: 0.9
            },
            {
                id: 'sub10',
                name: 'Subtraction to 10',
                facts: generateSubtractionFacts(10),
                requiredMastery: 0.9
            },
            {
                id: 'add20',
                name: 'Addition to 20',
                facts: generateAdditionFacts(20),
                requiredMastery: 0.9
            },
            {
                id: 'sub20',
                name: 'Subtraction to 20',
                facts: generateSubtractionFacts(20),
                requiredMastery: 0.9
            },
            {
                id: 'doubles',
                name: 'Doubles',
                facts: generateDoublesFacts(),
                requiredMastery: 0.9
            },
            {
                id: 'mult2',
                name: 'Multiply by 2',
                facts: generateMultiplicationFacts(2),
                requiredMastery: 0.9
            },
            {
                id: 'mult5',
                name: 'Multiply by 5',
                facts: generateMultiplicationFacts(5),
                requiredMastery: 0.9
            },
            {
                id: 'mult10',
                name: 'Multiply by 10',
                facts: generateMultiplicationFacts(10),
                requiredMastery: 0.9
            },
            {
                id: 'missing_add10',
                name: 'Missing Number +',
                facts: generateMissingAdditionFacts(10),
                requiredMastery: 0.9
            },
            {
                id: 'mult3',
                name: 'Multiply by 3',
                facts: generateMultiplicationFacts(3),
                requiredMastery: 0.9
            },
            {
                id: 'mult4',
                name: 'Multiply by 4',
                facts: generateMultiplicationFacts(4),
                requiredMastery: 0.9
            },
            {
                id: 'div2',
                name: 'Divide by 2',
                facts: generateDivisionFacts(2),
                requiredMastery: 0.9
            },
            {
                id: 'div5',
                name: 'Divide by 5',
                facts: generateDivisionFacts(5),
                requiredMastery: 0.9
            },
            {
                id: 'div10',
                name: 'Divide by 10',
                facts: generateDivisionFacts(10),
                requiredMastery: 0.9
            },
            {
                id: 'mult6',
                name: 'Multiply by 6',
                facts: generateMultiplicationFacts(6),
                requiredMastery: 0.9
            },
            {
                id: 'mult7',
                name: 'Multiply by 7',
                facts: generateMultiplicationFacts(7),
                requiredMastery: 0.9
            },
            {
                id: 'mult8',
                name: 'Multiply by 8',
                facts: generateMultiplicationFacts(8),
                requiredMastery: 0.9
            },
            {
                id: 'mult9',
                name: 'Multiply by 9',
                facts: generateMultiplicationFacts(9),
                requiredMastery: 0.9
            },
            {
                id: 'div3',
                name: 'Divide by 3',
                facts: generateDivisionFacts(3),
                requiredMastery: 0.9
            },
            {
                id: 'div4',
                name: 'Divide by 4',
                facts: generateDivisionFacts(4),
                requiredMastery: 0.9
            },
            {
                id: 'missing_sub10',
                name: 'Missing Number ‚àí',
                facts: generateMissingSubtractionFacts(10),
                requiredMastery: 0.9
            },
            {
                id: 'compare20',
                name: 'Compare Numbers',
                facts: generateComparisonFacts(20),
                requiredMastery: 0.9
            },
            {
                id: 'placevalue_tens',
                name: 'Place Value: Tens',
                facts: generatePlaceValueTensFacts(),
                requiredMastery: 0.9
            },
            {
                id: 'placevalue_ones',
                name: 'Place Value: Ones',
                facts: generatePlaceValueOnesFacts(),
                requiredMastery: 0.9
            },
            {
                id: 'placevalue_build',
                name: 'Build Numbers',
                facts: generatePlaceValueBuildFacts(),
                requiredMastery: 0.9
            },
            {
                id: 'fractions_half',
                name: 'Fractions: Halves',
                facts: generateFractionFacts('half'),
                requiredMastery: 0.9
            },
            {
                id: 'fractions_quarter',
                name: 'Fractions: Quarters',
                facts: generateFractionFacts('quarter'),
                requiredMastery: 0.9
            },
            {
                id: 'compare100',
                name: 'Compare to 100',
                facts: generateComparisonFacts(100),
                requiredMastery: 0.9
            },
            // Skip Counting
            {
                id: 'skip2',
                name: 'Count by 2s',
                facts: generateSkipCountingFacts(2),
                requiredMastery: 0.9
            },
            {
                id: 'skip5',
                name: 'Count by 5s',
                facts: generateSkipCountingFacts(5),
                requiredMastery: 0.9
            },
            {
                id: 'skip10',
                name: 'Count by 10s',
                facts: generateSkipCountingFacts(10),
                requiredMastery: 0.9
            },
            // Number Bonds
            {
                id: 'bonds10',
                name: 'Bonds to 10',
                facts: generateNumberBondsFacts(10),
                requiredMastery: 0.9
            },
            {
                id: 'bonds20',
                name: 'Bonds to 20',
                facts: generateNumberBondsFacts(20),
                requiredMastery: 0.9
            },
            // Even/Odd
            {
                id: 'evenodd',
                name: 'Even or Odd',
                facts: generateEvenOddFacts(),
                requiredMastery: 0.9
            },
            // Missing Multiplication
            {
                id: 'missing_mult2',
                name: 'Missing √ó 2',
                facts: generateMissingMultiplicationFacts(2),
                requiredMastery: 0.9
            },
            {
                id: 'missing_mult5',
                name: 'Missing √ó 5',
                facts: generateMissingMultiplicationFacts(5),
                requiredMastery: 0.9
            },
            {
                id: 'missing_mult10',
                name: 'Missing √ó 10',
                facts: generateMissingMultiplicationFacts(10),
                requiredMastery: 0.9
            },
            // More Division
            {
                id: 'div6',
                name: 'Divide by 6',
                facts: generateDivisionFacts(6),
                requiredMastery: 0.9
            },
            {
                id: 'div7',
                name: 'Divide by 7',
                facts: generateDivisionFacts(7),
                requiredMastery: 0.9
            },
            {
                id: 'div8',
                name: 'Divide by 8',
                facts: generateDivisionFacts(8),
                requiredMastery: 0.9
            },
            {
                id: 'div9',
                name: 'Divide by 9',
                facts: generateDivisionFacts(9),
                requiredMastery: 0.9
            },
            // Thirds
            {
                id: 'fractions_third',
                name: 'Fractions: Thirds',
                facts: generateFractionFacts('third'),
                requiredMastery: 0.9
            },
            // Number Sense
            {
                id: 'before20',
                name: 'Before (1-20)',
                facts: generateBeforeAfterFacts(20, 'before'),
                requiredMastery: 0.9
            },
            {
                id: 'after20',
                name: 'After (1-20)',
                facts: generateBeforeAfterFacts(20, 'after'),
                requiredMastery: 0.9
            },
            {
                id: 'round50',
                name: 'Rounding to 10',
                facts: generateRoundingFacts(50),
                requiredMastery: 0.9
            },
            {
                id: 'expanded',
                name: 'Expanded Form',
                facts: generateExpandedFormFacts(),
                requiredMastery: 0.9
            },
            // Fact Families
            {
                id: 'family10',
                name: 'Fact Families',
                facts: generateFactFamilyFacts(10),
                requiredMastery: 0.9
            },
            // Symbols
            {
                id: 'gtlt20',
                name: '< and > Signs',
                facts: generateGreaterLessFacts(20),
                requiredMastery: 0.9
            },
            // Word Problems
            {
                id: 'wordadd',
                name: 'Word Problems +',
                facts: generateWordProblemFacts('add'),
                requiredMastery: 0.9
            },
            {
                id: 'wordsub',
                name: 'Word Problems ‚àí',
                facts: generateWordProblemFacts('sub'),
                requiredMastery: 0.9
            },
            // Time
            {
                id: 'clockhour',
                name: 'Time: Hours',
                facts: generateClockFacts('hour'),
                requiredMastery: 0.9
            },
            {
                id: 'clockhalf',
                name: 'Time: Half Hours',
                facts: generateClockFacts('half'),
                requiredMastery: 0.9
            },
            // Money
            {
                id: 'coins',
                name: 'Counting Coins',
                facts: generateCoinFacts('count'),
                requiredMastery: 0.9
            },
            // Shapes
            {
                id: 'shapesides',
                name: 'Shape Sides',
                facts: generateShapeFacts('sides'),
                requiredMastery: 0.9
            },
            // Patterns
            {
                id: 'patterns',
                name: 'Number Patterns',
                facts: generatePatternFacts(),
                requiredMastery: 0.9
            },
            // Near Doubles Strategy
            {
                id: 'neardoubles',
                name: 'Near Doubles',
                facts: generateNearDoublesFacts(),
                requiredMastery: 0.9
            },
            // Number Ordering
            {
                id: 'ordering',
                name: 'Number Order',
                facts: generateNumberOrderFacts(),
                requiredMastery: 0.9
            },
            // Quarter Hours
            {
                id: 'clockquarter',
                name: 'Time: Quarters',
                facts: generateClockFacts('quarter'),
                requiredMastery: 0.9
            },
            // Quarters
            {
                id: 'quarters',
                name: 'Counting Quarters',
                facts: generateCoinFacts('quarters'),
                requiredMastery: 0.9
            },
            // Mixed Coins
            {
                id: 'mixedcoins',
                name: 'Mixed Coins',
                facts: generateCoinFacts('mixed'),
                requiredMastery: 0.9
            }
        ];

        // Generate fact sets (no trivial 0+x or x+0 facts)
        function generateAdditionFacts(max) {
            const facts = [];
            for (let a = 1; a <= max; a++) {
                for (let b = 1; b <= max - a; b++) {
                    if (a + b <= max) {
                        facts.push({ a, b, op: '+', answer: a + b, display: `${a} + ${b}` });
                    }
                }
            }
            return facts;
        }

        function generateSubtractionFacts(max) {
            const facts = [];
            for (let a = 2; a <= max; a++) {
                // Start b at 1 to avoid trivial x-0 facts
                for (let b = 1; b < a; b++) {
                    facts.push({ a, b, op: '-', answer: a - b, display: `${a} ‚àí ${b}` });
                }
            }
            return facts;
        }

        function generateDoublesFacts() {
            const facts = [];
            for (let a = 1; a <= 10; a++) {
                facts.push({ a, b: a, op: '+', answer: a + a, display: `${a} + ${a}` });
            }
            return facts;
        }

        function generateMultiplicationFacts(multiplier) {
            const facts = [];
            // Start at 1 to avoid trivial 0√óx facts
            for (let a = 1; a <= 10; a++) {
                facts.push({ a, b: multiplier, op: '√ó', answer: a * multiplier, display: `${a} √ó ${multiplier}` });
            }
            return facts;
        }

        function generateDivisionFacts(divisor) {
            const facts = [];
            // Generate division facts from multiplication (e.g., 6√∑2=3 from 2√ó3=6)
            for (let a = 1; a <= 10; a++) {
                const dividend = a * divisor;
                facts.push({ a: dividend, b: divisor, op: '√∑', answer: a, display: `${dividend} √∑ ${divisor}` });
            }
            return facts;
        }

        function generateMissingAdditionFacts(max) {
            const facts = [];
            // Problems like: 3 + ? = 7 (answer is 4)
            for (let sum = 3; sum <= max; sum++) {
                for (let a = 1; a < sum; a++) {
                    const missing = sum - a;
                    if (missing >= 1) {
                        facts.push({
                            a,
                            b: missing,
                            op: '+?',
                            answer: missing,
                            display: `${a} + ? = ${sum}`,
                            sum: sum
                        });
                    }
                }
            }
            return facts;
        }

        function generateMissingSubtractionFacts(max) {
            const facts = [];
            // Problems like: 7 ‚àí ? = 3 (answer is 4)
            for (let a = 3; a <= max; a++) {
                for (let result = 1; result < a; result++) {
                    const missing = a - result;
                    if (missing >= 1) {
                        facts.push({
                            a,
                            b: missing,
                            op: '-?',
                            answer: missing,
                            display: `${a} ‚àí ? = ${result}`,
                            result: result
                        });
                    }
                }
            }
            return facts;
        }

        function generateComparisonFacts(max) {
            const facts = [];
            // "Which is bigger?" - answer is the larger number
            // Generate pairs with various display orders (deterministic based on values)
            for (let a = 1; a <= max; a++) {
                for (let b = a + 1; b <= Math.min(a + 10, max); b++) {
                    // Use sum to deterministically decide order (keeps progress consistent)
                    if ((a + b) % 2 === 0) {
                        facts.push({
                            a, b,
                            op: 'compare',
                            answer: b,
                            display: `${a} ‚óã ${b}`,
                            smaller: a,
                            bigger: b
                        });
                    } else {
                        facts.push({
                            a: b, b: a,
                            op: 'compare',
                            answer: b,
                            display: `${b} ‚óã ${a}`,
                            smaller: a,
                            bigger: b
                        });
                    }
                }
            }
            return facts;
        }

        function generatePlaceValueTensFacts() {
            const facts = [];
            // "How many tens in 43?" ‚Üí 4
            for (let tens = 1; tens <= 9; tens++) {
                for (let ones = 0; ones <= 9; ones++) {
                    const num = tens * 10 + ones;
                    facts.push({
                        a: num,
                        op: 'tens',
                        answer: tens,
                        display: `Tens in ${num}?`
                    });
                }
            }
            return facts;
        }

        function generatePlaceValueOnesFacts() {
            const facts = [];
            // "How many ones in 43?" ‚Üí 3
            for (let tens = 1; tens <= 9; tens++) {
                for (let ones = 0; ones <= 9; ones++) {
                    const num = tens * 10 + ones;
                    facts.push({
                        a: num,
                        op: 'ones',
                        answer: ones,
                        display: `Ones in ${num}?`
                    });
                }
            }
            return facts;
        }

        function generatePlaceValueBuildFacts() {
            const facts = [];
            // "3 tens + 7 ones = ?" ‚Üí 37
            for (let tens = 1; tens <= 9; tens++) {
                for (let ones = 0; ones <= 9; ones++) {
                    const num = tens * 10 + ones;
                    facts.push({
                        a: tens,
                        b: ones,
                        op: 'build',
                        answer: num,
                        display: `${tens} tens + ${ones} ones`
                    });
                }
            }
            return facts;
        }

        function generateFractionFacts(type) {
            const facts = [];
            if (type === 'half') {
                // "Half of 8 = ?" ‚Üí 4
                for (let num = 2; num <= 20; num += 2) {
                    facts.push({
                        a: num,
                        op: 'half',
                        answer: num / 2,
                        display: `¬Ω of ${num} = ?`
                    });
                }
            } else if (type === 'quarter') {
                // "Quarter of 12 = ?" ‚Üí 3
                for (let num = 4; num <= 40; num += 4) {
                    facts.push({
                        a: num,
                        op: 'quarter',
                        answer: num / 4,
                        display: `¬º of ${num} = ?`
                    });
                }
            } else if (type === 'third') {
                // "Third of 9 = ?" ‚Üí 3
                for (let num = 3; num <= 30; num += 3) {
                    facts.push({
                        a: num,
                        op: 'third',
                        answer: num / 3,
                        display: `‚Öì of ${num} = ?`
                    });
                }
            }
            return facts;
        }

        function generateSkipCountingFacts(skip) {
            const facts = [];
            // "What comes next: 5, 10, 15, ?" ‚Üí 20
            for (let start = skip; start <= skip * 8; start += skip) {
                const seq = [start, start + skip, start + skip * 2];
                const answer = start + skip * 3;
                facts.push({
                    a: seq,
                    op: 'skip',
                    answer: answer,
                    display: `${seq.join(', ')}, ?`,
                    skip: skip
                });
            }
            return facts;
        }

        function generateNumberBondsFacts(target) {
            const facts = [];
            // "What pairs with 3 to make 10?" ‚Üí 7
            for (let a = 1; a < target; a++) {
                const b = target - a;
                facts.push({
                    a: a,
                    b: b,
                    op: 'bond',
                    answer: b,
                    display: `${a} + ? = ${target}`,
                    target: target
                });
            }
            return facts;
        }

        function generateEvenOddFacts() {
            const facts = [];
            // "Is 7 even or odd?" - answer: 1 for odd, 0 for even
            for (let num = 1; num <= 20; num++) {
                facts.push({
                    a: num,
                    op: 'evenodd',
                    answer: num % 2, // 0 = even, 1 = odd
                    display: `${num}: even or odd?`,
                    isOdd: num % 2 === 1
                });
            }
            return facts;
        }

        function generateMissingMultiplicationFacts(multiplier) {
            const facts = [];
            // "3 √ó ? = 12" ‚Üí 4
            for (let a = 1; a <= 10; a++) {
                const product = a * multiplier;
                facts.push({
                    a: multiplier,
                    b: a,
                    op: '√ó?',
                    answer: a,
                    display: `${multiplier} √ó ? = ${product}`,
                    product: product
                });
            }
            return facts;
        }

        function generateRoundingFacts(max) {
            const facts = [];
            // "Round 23 to nearest 10" ‚Üí 20
            for (let num = 1; num < max; num++) {
                if (num % 10 === 0) continue; // Skip already-round numbers
                const rounded = Math.round(num / 10) * 10;
                facts.push({
                    a: num,
                    op: 'round10',
                    answer: rounded,
                    display: `Round ${num} ‚Üí ?`
                });
            }
            return facts;
        }

        function generateBeforeAfterFacts(max, type) {
            const facts = [];
            if (type === 'before') {
                // "What comes before 7?" ‚Üí 6
                for (let num = 2; num <= max; num++) {
                    facts.push({
                        a: num,
                        op: 'before',
                        answer: num - 1,
                        display: `Before ${num}?`
                    });
                }
            } else {
                // "What comes after 7?" ‚Üí 8
                for (let num = 1; num < max; num++) {
                    facts.push({
                        a: num,
                        op: 'after',
                        answer: num + 1,
                        display: `After ${num}?`
                    });
                }
            }
            return facts;
        }

        function generateExpandedFormFacts() {
            const facts = [];
            // "34 = 30 + ?" ‚Üí 4
            for (let tens = 1; tens <= 9; tens++) {
                for (let ones = 1; ones <= 9; ones++) {
                    const num = tens * 10 + ones;
                    facts.push({
                        a: num,
                        b: tens * 10,
                        op: 'expanded',
                        answer: ones,
                        display: `${num} = ${tens * 10} + ?`
                    });
                }
            }
            return facts;
        }

        function generateFactFamilyFacts(max) {
            const facts = [];
            // Given 3 + 4 = 7, what is 7 - 4? ‚Üí 3
            for (let a = 1; a <= max; a++) {
                for (let b = 1; b <= max - a; b++) {
                    const sum = a + b;
                    if (sum <= max) {
                        // Addition shown, ask subtraction
                        facts.push({
                            a, b, sum,
                            op: 'family',
                            answer: a,
                            display: `${a}+${b}=${sum}, ${sum}‚àí${b}=?`
                        });
                    }
                }
            }
            return facts;
        }

        function generateGreaterLessFacts(max) {
            const facts = [];
            // "5 ‚óã 8" ‚Üí type < (answer: 1 for <, 2 for >)
            for (let a = 1; a <= max; a++) {
                for (let b = a + 1; b <= Math.min(a + 10, max); b++) {
                    // a < b
                    facts.push({
                        a, b,
                        op: 'gtlt',
                        answer: 1, // 1 = <, 2 = >
                        display: `${a} ‚óã ${b}`,
                        symbol: '<'
                    });
                    // b > a (reversed display)
                    facts.push({
                        a: b, b: a,
                        op: 'gtlt',
                        answer: 2,
                        display: `${b} ‚óã ${a}`,
                        symbol: '>'
                    });
                }
            }
            return facts;
        }

        function generateWordProblemFacts(type) {
            const facts = [];
            const names = ['Sam', 'Mia', 'Ben', 'Ava', 'Leo', 'Zoe'];
            const items = ['apple', 'cookie', 'star', 'ball', 'book', 'toy'];

            if (type === 'add') {
                for (let a = 1; a <= 5; a++) {
                    for (let b = 1; b <= 5; b++) {
                        const name = names[(a + b) % names.length];
                        const item = items[(a * b) % items.length];
                        facts.push({
                            a, b,
                            op: 'wordadd',
                            answer: a + b,
                            display: `${name}: ${a} ${item}s + ${b} more = ?`,
                            story: `${name} has ${a} ${item}${a > 1 ? 's' : ''}. Gets ${b} more.`
                        });
                    }
                }
            } else if (type === 'sub') {
                for (let a = 3; a <= 10; a++) {
                    for (let b = 1; b < a; b++) {
                        const name = names[(a + b) % names.length];
                        const item = items[(a * b) % items.length];
                        facts.push({
                            a, b,
                            op: 'wordsub',
                            answer: a - b,
                            display: `${name}: ${a} ${item}s ‚àí ${b} = ?`,
                            story: `${name} has ${a} ${item}${a > 1 ? 's' : ''}. Gives away ${b}.`
                        });
                    }
                }
            }
            return facts;
        }

        function generateClockFacts(type) {
            const facts = [];
            if (type === 'hour') {
                // "What time? [clock showing 3:00]" ‚Üí 3
                for (let hour = 1; hour <= 12; hour++) {
                    facts.push({
                        a: hour,
                        b: 0,
                        op: 'clock',
                        answer: hour,
                        display: `üïê ${hour}:00`,
                        hour: hour,
                        minute: 0
                    });
                }
            } else if (type === 'half') {
                // "What time? [clock showing 3:30]" ‚Üí answer is 30
                for (let hour = 1; hour <= 12; hour++) {
                    facts.push({
                        a: hour,
                        b: 30,
                        op: 'clockhalf',
                        answer: 30,
                        display: `üïê ${hour}:??`,
                        hour: hour,
                        minute: 30
                    });
                }
            } else if (type === 'quarter') {
                // Quarter past and quarter to
                for (let hour = 1; hour <= 12; hour++) {
                    // Quarter past (:15)
                    facts.push({
                        a: hour,
                        b: 15,
                        op: 'clockquarter',
                        answer: 15,
                        display: `üïê ${hour}:??`,
                        hour: hour,
                        minute: 15
                    });
                    // Quarter to (:45)
                    facts.push({
                        a: hour,
                        b: 45,
                        op: 'clockquarter',
                        answer: 45,
                        display: `üïê ${hour}:??`,
                        hour: hour,
                        minute: 45
                    });
                }
            }
            return facts;
        }

        function generateCoinFacts(type) {
            const facts = [];
            if (type === 'count') {
                // Count pennies
                for (let count = 2; count <= 10; count++) {
                    facts.push({
                        a: count,
                        op: 'coins',
                        answer: count,
                        display: `${count} pennies = ?¬¢`,
                        coinType: 'penny',
                        coinValue: 1,
                        coinCount: count
                    });
                }
                // Count nickels
                for (let count = 1; count <= 6; count++) {
                    facts.push({
                        a: count,
                        op: 'coins',
                        answer: count * 5,
                        display: `${count} nickel${count > 1 ? 's' : ''} = ?¬¢`,
                        coinType: 'nickel',
                        coinValue: 5,
                        coinCount: count
                    });
                }
                // Count dimes
                for (let count = 1; count <= 6; count++) {
                    facts.push({
                        a: count,
                        op: 'coins',
                        answer: count * 10,
                        display: `${count} dime${count > 1 ? 's' : ''} = ?¬¢`,
                        coinType: 'dime',
                        coinValue: 10,
                        coinCount: count
                    });
                }
            } else if (type === 'quarters') {
                // Count quarters
                for (let count = 1; count <= 4; count++) {
                    facts.push({
                        a: count,
                        op: 'coins',
                        answer: count * 25,
                        display: `${count} quarter${count > 1 ? 's' : ''} = ?¬¢`,
                        coinType: 'quarter',
                        coinValue: 25,
                        coinCount: count
                    });
                }
            } else if (type === 'mixed') {
                // Mixed coins
                const mixedProblems = [
                    { coins: [{type: 'quarter', count: 1}, {type: 'dime', count: 1}], total: 35 },
                    { coins: [{type: 'quarter', count: 1}, {type: 'nickel', count: 1}], total: 30 },
                    { coins: [{type: 'dime', count: 2}, {type: 'nickel', count: 1}], total: 25 },
                    { coins: [{type: 'quarter', count: 1}, {type: 'dime', count: 2}], total: 45 },
                    { coins: [{type: 'quarter', count: 2}], total: 50 },
                    { coins: [{type: 'dime', count: 3}, {type: 'nickel', count: 1}], total: 35 },
                    { coins: [{type: 'quarter', count: 1}, {type: 'nickel', count: 2}], total: 35 },
                    { coins: [{type: 'quarter', count: 2}, {type: 'dime', count: 1}], total: 60 },
                    { coins: [{type: 'dime', count: 1}, {type: 'nickel', count: 3}], total: 25 },
                    { coins: [{type: 'quarter', count: 1}, {type: 'dime', count: 1}, {type: 'nickel', count: 1}], total: 40 }
                ];
                mixedProblems.forEach((prob, i) => {
                    const display = prob.coins.map(c => `${c.count} ${c.type}${c.count > 1 ? 's' : ''}`).join(' + ');
                    facts.push({
                        a: prob.coins,
                        op: 'mixedcoins',
                        answer: prob.total,
                        display: `${display} = ?¬¢`,
                        coins: prob.coins
                    });
                });
            }
            return facts;
        }

        function generateShapeFacts(type) {
            const facts = [];
            const shapes = [
                { name: 'triangle', sides: 3, emoji: 'üî∫' },
                { name: 'square', sides: 4, emoji: 'üü¶' },
                { name: 'rectangle', sides: 4, emoji: 'üìã' },
                { name: 'pentagon', sides: 5, emoji: '‚¨†' },
                { name: 'hexagon', sides: 6, emoji: '‚¨°' }
            ];

            if (type === 'sides') {
                shapes.forEach(shape => {
                    facts.push({
                        a: shape.name,
                        op: 'shapesides',
                        answer: shape.sides,
                        display: `${shape.emoji} sides = ?`,
                        shapeName: shape.name,
                        emoji: shape.emoji
                    });
                });
            } else if (type === 'name') {
                // Given sides, name the shape (3=triangle, 4=square, etc)
                facts.push({ a: 3, op: 'shapename', answer: 3, display: '3 sides = ?', hint: 'tri___' });
                facts.push({ a: 4, op: 'shapename', answer: 4, display: '4 sides = ?', hint: 'squ___' });
                facts.push({ a: 5, op: 'shapename', answer: 5, display: '5 sides = ?', hint: 'pent___' });
                facts.push({ a: 6, op: 'shapename', answer: 6, display: '6 sides = ?', hint: 'hex___' });
            }
            return facts;
        }

        function generatePatternFacts() {
            const facts = [];
            // Number patterns
            const patterns = [
                { seq: [1, 2, 3, 4], next: 5 },
                { seq: [2, 4, 6, 8], next: 10 },
                { seq: [5, 10, 15, 20], next: 25 },
                { seq: [1, 3, 5, 7], next: 9 },
                { seq: [10, 20, 30, 40], next: 50 },
                { seq: [3, 6, 9, 12], next: 15 },
                { seq: [100, 90, 80, 70], next: 60 },
                { seq: [1, 4, 7, 10], next: 13 },
                { seq: [2, 5, 8, 11], next: 14 },
                { seq: [50, 45, 40, 35], next: 30 }
            ];

            patterns.forEach((p, i) => {
                facts.push({
                    a: p.seq,
                    op: 'pattern',
                    answer: p.next,
                    display: `${p.seq.join(', ')}, ?`
                });
            });

            return facts;
        }

        function generateNearDoublesFacts() {
            const facts = [];
            // Near doubles: 6+7 = 6+6+1 = 13
            for (let a = 1; a <= 9; a++) {
                const b = a + 1;
                facts.push({
                    a, b,
                    op: 'neardouble',
                    answer: a + b,
                    display: `${a} + ${b}`,
                    double: a,
                    hint: `${a}+${a}+1`
                });
                // Also b + a (reversed)
                facts.push({
                    a: b, b: a,
                    op: 'neardouble',
                    answer: a + b,
                    display: `${b} + ${a}`,
                    double: a,
                    hint: `${a}+${a}+1`
                });
            }
            return facts;
        }

        function generateNumberOrderFacts() {
            const facts = [];
            // Order 3 numbers from smallest to largest
            // Answer is the middle number (to keep it simple with numpad)
            for (let i = 0; i < 15; i++) {
                const a = Math.floor(Math.random() * 20) + 1;
                const b = a + Math.floor(Math.random() * 10) + 1;
                const c = b + Math.floor(Math.random() * 10) + 1;
                // Shuffle display order
                const nums = [a, b, c].sort(() => Math.random() - 0.5);
                facts.push({
                    a: nums,
                    op: 'order',
                    answer: b, // Middle number
                    display: `Order: ${nums.join(', ')}`,
                    sorted: [a, b, c],
                    hint: 'Which is in the middle?'
                });
            }
            return facts;
        }

        // ============================================
        // DATA STORAGE
        // ============================================
        const AVATARS = ['ü¶ä', 'üêº', 'ü¶Å', 'üê∏', 'üê±', 'üê∂', 'ü¶Ñ', 'üê∞'];
        const UNLOCKABLE_AVATARS = [
            { emoji: 'ü¶ã', name: 'Butterfly', requirement: 'Complete 5 tiers', check: p => (p.currentTierIndex || 0) >= 5 },
            { emoji: 'üêô', name: 'Octopus', requirement: 'Master 50 facts', check: p => countMasteredFacts(p) >= 50 },
            { emoji: 'ü¶ñ', name: 'Dinosaur', requirement: 'Answer 100 problems', check: p => (p.totalCorrect || 0) >= 100 },
            { emoji: 'üê≤', name: 'Dragon', requirement: '7 day streak', check: p => calculateStreak(p) >= 7 },
            { emoji: 'ü¶Ö', name: 'Eagle', requirement: 'Complete 10 tiers', check: p => (p.currentTierIndex || 0) >= 10 },
            { emoji: 'üê¨', name: 'Dolphin', requirement: 'Master 100 facts', check: p => countMasteredFacts(p) >= 100 },
            { emoji: 'ü¶ú', name: 'Parrot', requirement: 'Complete 20 tiers', check: p => (p.currentTierIndex || 0) >= 20 },
            { emoji: 'üêù', name: 'Bee', requirement: 'Answer 1000 problems', check: p => (p.totalCorrect || 0) >= 1000 }
        ];

        const ACHIEVEMENTS = [
            { id: 'first10', name: 'Getting Started', emoji: 'üå±', desc: 'Answer 10 problems', check: p => (p.totalCorrect || 0) >= 10 },
            { id: 'first100', name: 'Century Club', emoji: 'üíØ', desc: 'Answer 100 problems', check: p => (p.totalCorrect || 0) >= 100 },
            { id: 'first500', name: 'Math Explorer', emoji: 'üß≠', desc: 'Answer 500 problems', check: p => (p.totalCorrect || 0) >= 500 },
            { id: 'first1000', name: 'Math Master', emoji: 'üëë', desc: 'Answer 1000 problems', check: p => (p.totalCorrect || 0) >= 1000 },
            { id: 'streak3', name: 'On a Roll', emoji: 'üî•', desc: '3 day streak', check: p => calculateStreak(p) >= 3 },
            { id: 'streak7', name: 'Week Warrior', emoji: '‚ö°', desc: '7 day streak', check: p => calculateStreak(p) >= 7 },
            { id: 'streak30', name: 'Monthly Champion', emoji: 'üèÜ', desc: '30 day streak', check: p => calculateStreak(p) >= 30 },
            { id: 'perfect10', name: 'Perfect 10', emoji: '‚≠ê', desc: '10 correct in a row', check: p => (p.bestStreak || 0) >= 10 },
            { id: 'tier5', name: 'Level Up!', emoji: 'üìà', desc: 'Complete 5 tiers', check: p => (p.currentTierIndex || 0) >= 5 },
            { id: 'tier10', name: 'Rising Star', emoji: 'üåü', desc: 'Complete 10 tiers', check: p => (p.currentTierIndex || 0) >= 10 },
            { id: 'tier20', name: 'Superstar', emoji: 'üí´', desc: 'Complete 20 tiers', check: p => (p.currentTierIndex || 0) >= 20 },
            { id: 'mastery50', name: 'Fact Finder', emoji: 'üîç', desc: 'Master 50 facts', check: p => countMasteredFacts(p) >= 50 },
            { id: 'mastery100', name: 'Fact Collector', emoji: 'üìö', desc: 'Master 100 facts', check: p => countMasteredFacts(p) >= 100 },
            { id: 'mastery200', name: 'Fact Expert', emoji: 'üéì', desc: 'Master 200 facts', check: p => countMasteredFacts(p) >= 200 }
        ];

        let profiles = [];
        let currentProfile = null;
        let currentInput = '';
        let currentFact = null;
        let sessionStats = { correct: 0, wrong: 0, newlyMastered: [], needsPractice: [], correctStreak: 0 };
        let selectedAvatar = 'ü¶ä';
        let reviewMode = false;
        let timedMode = false;
        let timedModeTimer = null;
        let timedModeTimeLeft = 60; // seconds
        let timedModeScore = 0;

        // Pomodoro settings
        let pomodoroLength = 25 * 60; // 25 minutes in seconds
        let breakLength = 5 * 60; // 5 minutes in seconds
        let masteryGoal = 5; // facts to master per session
        let pomodoroTimeLeft = 0;
        let pomodoroTimer = null;
        let pomodoroActive = false;
        let onBreak = false;

        // Audio/Visual settings
        let soundEnabled = true;
        let speakEnabled = true;
        let dotsEnabled = true;
        let audioContext = null;

        function countMasteredFacts(profile) {
            if (!profile.factProgress) return 0;
            return Object.values(profile.factProgress).filter(p => p.mastered).length;
        }

        function checkAchievements(profile) {
            if (!profile.achievements) profile.achievements = [];
            const newAchievements = [];

            ACHIEVEMENTS.forEach(achievement => {
                if (!profile.achievements.includes(achievement.id) && achievement.check(profile)) {
                    profile.achievements.push(achievement.id);
                    newAchievements.push(achievement);
                }
            });

            return newAchievements;
        }

        // ============================================
        // SOUND EFFECTS
        // ============================================
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(type) {
            if (!soundEnabled) return;
            initAudio();

            const oscillator = audioContext.createOscillator();
            const gain = audioContext.createGain();
            oscillator.connect(gain);
            gain.connect(audioContext.destination);

            if (type === 'tap') {
                oscillator.frequency.value = 600;
                gain.gain.value = 0.1;
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.05);
            } else if (type === 'correct') {
                oscillator.frequency.value = 523; // C5
                gain.gain.value = 0.15;
                oscillator.start();
                setTimeout(() => oscillator.frequency.value = 659, 100); // E5
                setTimeout(() => oscillator.frequency.value = 784, 200); // G5
                oscillator.stop(audioContext.currentTime + 0.35);
            } else if (type === 'wrong') {
                oscillator.frequency.value = 200;
                gain.gain.value = 0.15;
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.3);
            } else if (type === 'mastered') {
                oscillator.frequency.value = 523;
                gain.gain.value = 0.15;
                oscillator.start();
                setTimeout(() => oscillator.frequency.value = 659, 100);
                setTimeout(() => oscillator.frequency.value = 784, 200);
                setTimeout(() => oscillator.frequency.value = 1047, 300);
                oscillator.stop(audioContext.currentTime + 0.5);
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundBtn').classList.toggle('active', soundEnabled);
            if (soundEnabled) playSound('tap');
        }

        // ============================================
        // SPEECH SYNTHESIS (Read Aloud)
        // ============================================
        function speakProblem(fact) {
            if (!speakEnabled || !('speechSynthesis' in window)) return;

            // Cancel any ongoing speech
            speechSynthesis.cancel();

            // Build the sentence
            let text = '';
            if (fact.op === '+') {
                text = `What is ${fact.a} plus ${fact.b}?`;
            } else if (fact.op === '-' || fact.op === '‚àí') {
                text = `What is ${fact.a} minus ${fact.b}?`;
            } else if (fact.op === '√ó') {
                text = `What is ${fact.a} times ${fact.b}?`;
            } else if (fact.op === '√∑') {
                text = `What is ${fact.a} divided by ${fact.b}?`;
            } else if (fact.op === '+?') {
                text = `${fact.a} plus what equals ${fact.sum}?`;
            } else if (fact.op === '-?') {
                text = `${fact.a} minus what equals ${fact.result}?`;
            } else if (fact.op === 'compare') {
                text = `Which is bigger? ${fact.a} or ${fact.b}?`;
            } else if (fact.op === 'tens') {
                text = `How many tens are in ${fact.a}?`;
            } else if (fact.op === 'ones') {
                text = `How many ones are in ${fact.a}?`;
            } else if (fact.op === 'build') {
                text = `${fact.a} tens and ${fact.b} ones equals what?`;
            } else if (fact.op === 'half') {
                text = `What is half of ${fact.a}?`;
            } else if (fact.op === 'quarter') {
                text = `What is one quarter of ${fact.a}?`;
            } else if (fact.op === 'third') {
                text = `What is one third of ${fact.a}?`;
            } else if (fact.op === 'skip') {
                text = `${fact.a.join(', ')}... what comes next?`;
            } else if (fact.op === 'bond') {
                text = `${fact.a} plus what equals ${fact.target}?`;
            } else if (fact.op === 'evenodd') {
                text = `Is ${fact.a} even or odd? Press 0 for even, 1 for odd.`;
            } else if (fact.op === '√ó?') {
                text = `${fact.a} times what equals ${fact.product}?`;
            } else if (fact.op === 'round10') {
                text = `Round ${fact.a} to the nearest ten.`;
            } else if (fact.op === 'before') {
                text = `What number comes before ${fact.a}?`;
            } else if (fact.op === 'after') {
                text = `What number comes after ${fact.a}?`;
            } else if (fact.op === 'expanded') {
                text = `${fact.a} equals ${fact.b} plus what?`;
            } else if (fact.op === 'family') {
                text = `If ${fact.a} plus ${fact.b} equals ${fact.sum}, what is ${fact.sum} minus ${fact.b}?`;
            } else if (fact.op === 'gtlt') {
                text = `${fact.a} is... 1 for less than, 2 for greater than... ${fact.b}`;
            } else if (fact.op === 'wordadd') {
                text = fact.story + ` How many total?`;
            } else if (fact.op === 'wordsub') {
                text = fact.story + ` How many left?`;
            } else if (fact.op === 'clock') {
                text = `What hour does the clock show? ${fact.hour} o'clock.`;
            } else if (fact.op === 'clockhalf') {
                text = `The hour is ${fact.hour}. What are the minutes? Half past the hour.`;
            } else if (fact.op === 'coins') {
                text = `How many cents is ${fact.a} ${fact.coinType}${fact.a > 1 ? 's' : ''}?`;
            } else if (fact.op === 'shapesides') {
                text = `How many sides does a ${fact.shapeName} have?`;
            } else if (fact.op === 'pattern') {
                text = `${fact.a.join(', ')}... what comes next in the pattern?`;
            } else if (fact.op === 'neardouble') {
                text = `What is ${fact.a} plus ${fact.b}? Think: ${fact.double} plus ${fact.double} plus 1.`;
            } else if (fact.op === 'order') {
                text = `Put these in order: ${fact.a.join(', ')}. What is the middle number?`;
            } else if (fact.op === 'clockquarter') {
                text = `The hour is ${fact.hour}. What are the minutes?`;
            } else if (fact.op === 'mixedcoins') {
                const coinText = fact.coins.map(c => `${c.count} ${c.type}${c.count > 1 ? 's' : ''}`).join(' and ');
                text = `How many cents is ${coinText}?`;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.1;
            speechSynthesis.speak(utterance);
        }

        function speakFeedback(correct, answer, fact) {
            if (!speakEnabled || !('speechSynthesis' in window)) return;

            speechSynthesis.cancel();

            let text = correct ? 'Correct!' : `The answer is ${answer}`;

            // Special feedback for certain types
            if (!correct && fact) {
                if (fact.op === 'evenodd') {
                    text = fact.isOdd ? `${fact.a} is odd` : `${fact.a} is even`;
                } else if (fact.op === 'gtlt') {
                    text = `${fact.a} is ${fact.symbol === '<' ? 'less than' : 'greater than'} ${fact.b}`;
                } else if (fact.op === 'clockhalf') {
                    text = `The answer is 30 minutes, or half past`;
                }
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.1;
            speechSynthesis.speak(utterance);
        }

        function toggleSpeak() {
            speakEnabled = !speakEnabled;
            document.getElementById('speakBtn').classList.toggle('active', speakEnabled);
            if (speakEnabled && currentFact) speakProblem(currentFact);
        }

        // ============================================
        // COUNTING DOTS
        // ============================================
        function renderDots(fact) {
            const container = document.getElementById('dotsContainer');

            // Skip dots for multiplication/division (too many) or large numbers
            if (!dotsEnabled || !fact) {
                container.innerHTML = '';
                return;
            }

            // Skip dots for multiplication, division, or numbers > 12 (except for special ops)
            const skipOps = ['√ó', '√∑', 'tens', 'ones', 'build'];
            if (skipOps.includes(fact.op)) {
                container.innerHTML = '';
                return;
            }
            if ((fact.op === '+' || fact.op === '-' || fact.op === '‚àí') && (fact.a > 12 || fact.b > 12)) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            // Standard addition: show two groups
            if (fact.op === '+') {
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.a; i++) html += '<div class="dot"></div>';
                html += '</div>';
                html += '<div class="dots-operator">+</div>';
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.b; i++) html += '<div class="dot second"></div>';
                html += '</div>';
            }
            // Subtraction: show crossed out dots
            else if (fact.op === '-' || fact.op === '‚àí') {
                html = '<div class="dot-group">';
                for (let i = 0; i < fact.a; i++) {
                    if (i < fact.b) {
                        html += '<div class="dot" style="opacity:0.3;"></div>';
                    } else {
                        html += '<div class="dot"></div>';
                    }
                }
                html += '</div>';
            }
            // Missing addition: show known + ? = total
            else if (fact.op === '+?') {
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.a; i++) html += '<div class="dot"></div>';
                html += '</div>';
                html += '<div class="dots-operator">+</div>';
                html += '<div class="dots-result">?</div>';
                html += '<div class="dots-equals">=</div>';
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.sum; i++) html += '<div class="dot" style="opacity:0.5;"></div>';
                html += '</div>';
            }
            // Missing subtraction: show total - ? = result
            else if (fact.op === '-?') {
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.a; i++) html += '<div class="dot"></div>';
                html += '</div>';
                html += '<div class="dots-operator">‚àí</div>';
                html += '<div class="dots-result">?</div>';
                html += '<div class="dots-equals">=</div>';
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.result; i++) html += '<div class="dot second"></div>';
                html += '</div>';
            }
            // Comparison: show two groups side by side
            else if (fact.op === 'compare' && fact.a <= 12 && fact.b <= 12) {
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.a; i++) html += '<div class="dot"></div>';
                html += '</div>';
                html += '<div class="dots-operator">vs</div>';
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.b; i++) html += '<div class="dot second"></div>';
                html += '</div>';
            }
            // Fractions: show visual representation
            else if (fact.op === 'half') {
                // Show a bar divided in half with one part shaded
                html = `<div style="display:flex;gap:4px;">`;
                html += `<div style="width:40px;height:40px;background:var(--primary);border-radius:4px;"></div>`;
                html += `<div style="width:40px;height:40px;background:rgba(255,255,255,0.1);border:2px solid var(--primary);border-radius:4px;"></div>`;
                html += `</div>`;
                html += `<div class="dots-equals">=</div>`;
                html += `<div class="dots-result">?</div>`;
            }
            else if (fact.op === 'quarter') {
                // Show a bar divided in quarters with one part shaded
                html = `<div style="display:flex;gap:4px;">`;
                html += `<div style="width:30px;height:30px;background:var(--accent);border-radius:4px;"></div>`;
                for (let i = 0; i < 3; i++) {
                    html += `<div style="width:30px;height:30px;background:rgba(255,255,255,0.1);border:2px solid var(--accent);border-radius:4px;"></div>`;
                }
                html += `</div>`;
                html += `<div class="dots-equals">=</div>`;
                html += `<div class="dots-result">?</div>`;
            }
            else if (fact.op === 'third') {
                // Show a bar divided in thirds with one part shaded
                html = `<div style="display:flex;gap:4px;">`;
                html += `<div style="width:35px;height:35px;background:var(--success);border-radius:4px;"></div>`;
                for (let i = 0; i < 2; i++) {
                    html += `<div style="width:35px;height:35px;background:rgba(255,255,255,0.1);border:2px solid var(--success);border-radius:4px;"></div>`;
                }
                html += `</div>`;
                html += `<div class="dots-equals">=</div>`;
                html += `<div class="dots-result">?</div>`;
            }
            // Number bonds: show dots for both parts
            else if (fact.op === 'bond' && fact.target <= 12) {
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.a; i++) html += '<div class="dot"></div>';
                html += '</div>';
                html += '<div class="dots-operator">+</div>';
                html += '<div class="dots-result">?</div>';
                html += '<div class="dots-equals">=</div>';
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.target; i++) html += '<div class="dot" style="opacity:0.5;"></div>';
                html += '</div>';
            }
            // Even/Odd: show dots to help visualize pairs
            else if (fact.op === 'evenodd' && fact.a <= 12) {
                html = '<div class="dot-group" style="max-width:150px;">';
                for (let i = 0; i < fact.a; i++) {
                    html += '<div class="dot"></div>';
                }
                html += '</div>';
            }
            // Clock: show visual analog clock face
            else if (fact.op === 'clock' || fact.op === 'clockhalf' || fact.op === 'clockquarter') {
                const clockContainer = document.getElementById('clockContainer');
                const hourAngle = (fact.hour % 12) * 30 + (fact.minute / 60) * 30;
                const minuteAngle = fact.minute * 6;

                let clockHtml = '<div class="clock-face">';
                clockHtml += '<div class="clock-center"></div>';
                clockHtml += `<div class="clock-hand hour" style="transform: rotate(${hourAngle}deg);"></div>`;
                clockHtml += `<div class="clock-hand minute" style="transform: rotate(${minuteAngle}deg);"></div>`;

                // Add clock numbers
                const numbers = [12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
                const radius = 45;
                numbers.forEach((num, i) => {
                    const angle = (i * 30 - 90) * Math.PI / 180;
                    const x = 60 + radius * Math.cos(angle) - 8;
                    const y = 60 + radius * Math.sin(angle) - 8;
                    clockHtml += `<span class="clock-number" style="left:${x}px;top:${y}px;">${num}</span>`;
                });

                clockHtml += '</div>';
                clockContainer.innerHTML = clockHtml;
                clockContainer.style.display = 'block';
                return; // Don't use dots container for clock
            }
            // Coins: show visual coin images
            else if (fact.op === 'coins' && fact.coinType) {
                html = '<div style="display:flex;flex-wrap:wrap;justify-content:center;gap:4px;">';
                const coinValue = { penny: 1, nickel: 5, dime: 10, quarter: 25 };
                const count = fact.answer / coinValue[fact.coinType];
                for (let i = 0; i < count; i++) {
                    html += `<div class="coin ${fact.coinType}">${coinValue[fact.coinType]}¬¢</div>`;
                }
                html += '</div>';
            }
            // Mixed coins: show different coin types
            else if (fact.op === 'mixedcoins' && fact.coins) {
                html = '<div style="display:flex;flex-wrap:wrap;justify-content:center;gap:4px;">';
                const coinValue = { penny: 1, nickel: 5, dime: 10, quarter: 25 };
                fact.coins.forEach(coin => {
                    for (let i = 0; i < coin.count; i++) {
                        html += `<div class="coin ${coin.type}">${coinValue[coin.type]}¬¢</div>`;
                    }
                });
                html += '</div>';
            }
            // Near doubles: show the doubles hint visually
            else if (fact.op === 'neardouble') {
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.a; i++) html += '<div class="dot"></div>';
                html += '</div>';
                html += '<div class="dots-operator">+</div>';
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.b; i++) html += '<div class="dot second"></div>';
                html += '</div>';
            }
            // Number ordering: show the three numbers
            else if (fact.op === 'order' && fact.a) {
                html = '<div style="display:flex;gap:15px;justify-content:center;">';
                fact.a.forEach(num => {
                    html += `<div style="width:40px;height:40px;background:var(--card-bg);border:2px solid var(--primary);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:bold;">${num}</div>`;
                });
                html += '</div>';
            }

            // Hide clock container for non-clock problems
            document.getElementById('clockContainer').style.display = 'none';

            container.innerHTML = html;
        }

        function toggleDots() {
            dotsEnabled = !dotsEnabled;
            document.getElementById('dotsBtn').classList.toggle('active', dotsEnabled);
            if (currentFact) renderDots(currentFact);
        }

        // ============================================
        // HINT SYSTEM
        // ============================================
        let currentHint = '';

        function showHint() {
            if (!currentFact || !currentHint) return;

            const hintText = document.getElementById('hintText');
            hintText.textContent = currentHint;
            hintText.style.display = 'block';
            document.getElementById('hintBtn').style.display = 'none';

            // Speak the hint
            if (speakEnabled) {
                const utterance = new SpeechSynthesisUtterance(currentHint);
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
        }

        function getHintForFact(fact) {
            if (!fact) return '';

            // Operation-specific hints
            const hints = {
                '+': `Count ${fact.a} then add ${fact.b} more`,
                '-': `Start at ${fact.a} and take away ${fact.b}`,
                '‚àí': `Start at ${fact.a} and take away ${fact.b}`,
                '√ó': `${fact.a} groups of ${fact.b}`,
                '√∑': `Share ${fact.a} into ${fact.b} equal groups`,
                '+?': `What plus ${fact.a} equals ${fact.sum}?`,
                '-?': `${fact.a} minus what equals ${fact.result}?`,
                '√ó?': `${fact.a} times what equals ${fact.product}?`,
                'compare': `Count each group. Which has more?`,
                'tens': `The tens digit is on the left`,
                'ones': `The ones digit is on the right`,
                'bond': `What plus ${fact.a} equals ${fact.target}?`,
                'evenodd': `Even numbers can be split into pairs`,
                'skip': `Add ${fact.by} each time`,
                'clock': `The short hand points to the hour`,
                'clockhalf': `The long hand at 6 means 30 minutes`,
                'clockquarter': `The long hand at 3 means 15, at 9 means 45`,
                'coins': `Count by the coin value`,
                'neardouble': `Double ${fact.double}, then add 1`,
                'order': `Which number is in the middle when sorted?`,
                'round10': `Look at the ones digit. 5 or more rounds up`,
                'gtlt': `< means less than, > means greater than`,
                'shapesides': `Count each straight edge`,
                'pattern': `What repeats? Find the pattern`
            };

            return hints[fact.op] || `Think about it step by step`;
        }

        function hideHint() {
            document.getElementById('hintBtn').style.display = 'none';
            document.getElementById('hintText').style.display = 'none';
            currentHint = '';
        }

        // ============================================
        // CONFETTI CELEBRATION
        // ============================================
        function showConfetti() {
            const container = document.getElementById('confettiContainer');
            const colors = ['#ffd93d', '#ff6b9d', '#6bcb77', '#4ecdc4', '#ff6b6b', '#a66cff'];

            // Create 50 confetti pieces
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animation = `confetti-fall ${2 + Math.random() * 2}s ease-out forwards`;

                container.appendChild(confetti);
            }

            // Clean up after animation
            setTimeout(() => {
                container.innerHTML = '';
            }, 4000);
        }

        // ============================================
        // TIMED CHALLENGE MODE
        // ============================================
        function startTimedMode(profileIndex) {
            currentProfile = profiles[profileIndex];
            timedMode = true;
            timedModeScore = 0;
            timedModeTimeLeft = 60;
            sessionStats = { correct: 0, wrong: 0, newlyMastered: [], needsPractice: [], correctStreak: 0 };

            // Update UI for timed mode
            document.getElementById('currentAvatar').textContent = currentProfile.avatar;
            document.getElementById('currentName').innerHTML = currentProfile.name + '<span class="timed-badge">‚è±Ô∏è TIMED</span>';
            document.getElementById('currentTier').textContent = '60 second challenge!';
            document.getElementById('tierName').textContent = 'Timed Challenge';
            document.querySelector('.tier-progress').style.display = 'none';
            document.getElementById('pomodoroSection').style.display = 'none';
            document.getElementById('timerBar').style.display = 'block';
            document.getElementById('timerFill').style.width = '100%';
            document.getElementById('timerFill').className = 'timer-fill';

            showScreen('practiceScreen');

            // Start timer
            timedModeTimer = setInterval(updateTimedMode, 100);

            // Generate first problem
            generateProblem();
        }

        function updateTimedMode() {
            timedModeTimeLeft -= 0.1;
            const percentage = (timedModeTimeLeft / 60) * 100;
            const timerFill = document.getElementById('timerFill');

            timerFill.style.width = percentage + '%';

            // Color changes
            if (timedModeTimeLeft <= 10) {
                timerFill.className = 'timer-fill danger';
            } else if (timedModeTimeLeft <= 20) {
                timerFill.className = 'timer-fill warning';
            }

            if (timedModeTimeLeft <= 0) {
                endTimedMode();
            }
        }

        function endTimedMode() {
            clearInterval(timedModeTimer);
            timedModeTimer = null;
            timedMode = false;

            document.getElementById('timerBar').style.display = 'none';
            // Restore UI elements hidden during timed mode
            document.querySelector('.tier-progress').style.display = 'block';
            document.getElementById('pomodoroSection').style.display = 'flex';

            // Update best score
            if (!currentProfile.bestTimedScore || timedModeScore > currentProfile.bestTimedScore) {
                currentProfile.bestTimedScore = timedModeScore;
                saveProfiles();
            }

            // Show results
            showTimedResults();
        }

        function showTimedResults() {
            showConfetti();

            const isPB = timedModeScore === currentProfile.bestTimedScore;

            // Update session screen for timed mode display
            document.getElementById('sessionCorrect').textContent = timedModeScore;
            document.getElementById('sessionAccuracy').textContent = timedModeScore;
            document.getElementById('sessionAccuracyLabel').textContent = 'Solved in 60s';

            // Show streak or personal best
            if (isPB && timedModeScore > 0) {
                document.getElementById('streakDisplay').style.display = 'flex';
                document.getElementById('streakCount').textContent = 'üèÜ';
                document.getElementById('streakLabel').textContent = 'New Best!';
            } else {
                document.getElementById('streakDisplay').style.display = 'flex';
                document.getElementById('streakCount').textContent = currentProfile.bestTimedScore || 0;
                document.getElementById('streakLabel').textContent = 'Best Score';
            }

            // Hide mastered/practice sections for timed mode
            document.getElementById('masteredSection').style.display = 'none';
            document.getElementById('practiceMoreSection').style.display = 'none';

            showScreen('sessionScreen');
        }

        // ============================================
        // POMODORO TIMER SYSTEM
        // ============================================
        function startPomodoro() {
            pomodoroActive = true;
            onBreak = false;
            pomodoroTimeLeft = pomodoroLength;
            sessionStats = { correct: 0, wrong: 0, newlyMastered: [], needsPractice: [], correctStreak: 0 };

            updatePomodoroDisplay();
            document.getElementById('masteryProgress').textContent = '0';
            document.getElementById('masteryGoalDisplay').textContent = masteryGoal;

            // Start the timer
            if (pomodoroTimer) clearInterval(pomodoroTimer);
            pomodoroTimer = setInterval(updatePomodoro, 1000);
        }

        function updatePomodoro() {
            if (!pomodoroActive || onBreak) return;

            pomodoroTimeLeft--;
            updatePomodoroDisplay();

            // Check if time is up
            if (pomodoroTimeLeft <= 0) {
                triggerBreak('time');
            }
        }

        function updatePomodoroDisplay() {
            const minutes = Math.floor(pomodoroTimeLeft / 60);
            const seconds = pomodoroTimeLeft % 60;
            const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            const timeEl = document.getElementById('pomodoroTime');
            timeEl.textContent = timeStr;

            // Color changes for urgency
            timeEl.classList.remove('warning', 'danger');
            if (pomodoroTimeLeft <= 60) {
                timeEl.classList.add('danger');
            } else if (pomodoroTimeLeft <= 300) {
                timeEl.classList.add('warning');
            }
        }

        function updateMasteryDisplay() {
            document.getElementById('masteryProgress').textContent = sessionStats.newlyMastered.length;

            // Check if mastery goal reached
            if (sessionStats.newlyMastered.length >= masteryGoal) {
                triggerBreak('mastery');
            }
        }

        function triggerBreak(reason) {
            pomodoroActive = false;
            onBreak = true;

            if (pomodoroTimer) {
                clearInterval(pomodoroTimer);
                pomodoroTimer = null;
            }

            // Show confetti for completing a session
            showConfetti();
            playSound('mastered');

            // Update break screen stats
            const total = sessionStats.correct + sessionStats.wrong;
            const accuracy = total > 0 ? Math.round((sessionStats.correct / total) * 100) : 0;

            document.getElementById('breakCorrect').textContent = sessionStats.correct;
            document.getElementById('breakMastered').textContent = sessionStats.newlyMastered.length;
            document.getElementById('breakAccuracy').textContent = accuracy + '%';

            // Update subtitle based on reason
            const subtitle = document.querySelector('.break-subtitle');
            if (reason === 'mastery') {
                subtitle.textContent = `Amazing! You mastered ${masteryGoal} facts!`;
            } else {
                subtitle.textContent = 'Great focus! Time for a breather.';
            }

            // Show break overlay and start break timer
            document.getElementById('breakOverlay').classList.add('active');
            startBreakTimer();
        }

        function startBreakTimer() {
            let breakTimeLeft = breakLength;
            updateBreakTimerDisplay(breakTimeLeft);

            const breakTimer = setInterval(() => {
                breakTimeLeft--;
                updateBreakTimerDisplay(breakTimeLeft);

                if (breakTimeLeft <= 0) {
                    clearInterval(breakTimer);
                    // Could auto-start next round or just wait for user
                }
            }, 1000);
        }

        function updateBreakTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('breakTimer').textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function startNextPomodoro() {
            document.getElementById('breakOverlay').classList.remove('active');
            onBreak = false;
            startPomodoro();
            generateProblem();
        }

        function finishPractice() {
            document.getElementById('breakOverlay').classList.remove('active');
            onBreak = false;
            pomodoroActive = false;
            if (pomodoroTimer) {
                clearInterval(pomodoroTimer);
                pomodoroTimer = null;
            }
            showProfiles();
        }

        function stopPomodoro() {
            pomodoroActive = false;
            if (pomodoroTimer) {
                clearInterval(pomodoroTimer);
                pomodoroTimer = null;
            }
        }

        // ============================================
        // PROFILE MANAGEMENT
        // ============================================
        function loadProfiles() {
            const saved = localStorage.getItem('nanana_profiles');
            profiles = saved ? JSON.parse(saved) : [];
            renderProfiles();
        }

        function saveProfiles() {
            localStorage.setItem('nanana_profiles', JSON.stringify(profiles));
        }

        function renderProfiles() {
            const grid = document.getElementById('profilesGrid');
            grid.innerHTML = '';

            profiles.forEach((profile, index) => {
                const card = document.createElement('div');
                card.className = 'profile-card';
                card.onclick = (e) => {
                    if (!e.target.classList.contains('parent-btn') && !e.target.classList.contains('profile-action-btn')) {
                        selectProfile(index);
                    }
                };

                const tier = getCurrentTier(profile);
                const streak = calculateStreak(profile);
                const streakHTML = streak > 0 ? `<div class="profile-streak">üî• ${streak} day${streak > 1 ? 's' : ''}</div>` : '';
                const achievementCount = (profile.achievements || []).length;
                const hasStruggles = Object.values(profile.factProgress || {}).some(p => p.wrong > 0 && !p.mastered);

                const bestTimed = profile.bestTimedScore ? `‚è±Ô∏è ${profile.bestTimedScore}` : '‚è±Ô∏è';

                card.innerHTML = `
                    <button class="parent-btn" onclick="event.stopPropagation(); showParentView(${index})" title="View progress">üìä</button>
                    <div class="profile-avatar">${profile.avatar}</div>
                    <div class="profile-name">${profile.name}</div>
                    <div class="profile-level">${tier ? tier.name : 'Starting'}</div>
                    ${streakHTML}
                    <div class="profile-actions">
                        <button class="profile-action-btn" onclick="event.stopPropagation(); showAchievements(${index})">üèÜ ${achievementCount}</button>
                        <button class="profile-action-btn" onclick="event.stopPropagation(); startTimedMode(${index})" title="60 second challenge">${bestTimed}</button>
                        ${hasStruggles ? `<button class="profile-action-btn" onclick="event.stopPropagation(); startReviewMode(${index})">üìù Review</button>` : ''}
                    </div>
                `;
                grid.appendChild(card);
            });

            // Settings button
            const settingsCard = document.createElement('div');
            settingsCard.className = 'profile-card add-new';
            settingsCard.onclick = showSettings;
            settingsCard.innerHTML = `
                <div class="profile-avatar">‚öôÔ∏è</div>
                <div class="profile-name">Settings</div>
            `;
            grid.appendChild(settingsCard);

            // Add new profile card
            const addCard = document.createElement('div');
            addCard.className = 'profile-card add-new';
            addCard.onclick = showAddProfile;
            addCard.innerHTML = `
                <div class="profile-avatar">+</div>
                <div class="profile-name">Add Player</div>
            `;
            grid.appendChild(addCard);
        }

        // Calculate consecutive day streak
        function calculateStreak(profile) {
            if (!profile.dailyProgress) return 0;

            const dates = Object.keys(profile.dailyProgress).sort().reverse();
            if (dates.length === 0) return 0;

            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

            // Must have practiced today or yesterday to have an active streak
            if (dates[0] !== today && dates[0] !== yesterday) return 0;

            let streak = 0;
            let checkDate = new Date(dates[0]);

            for (const dateStr of dates) {
                const date = new Date(dateStr);
                const expectedDate = new Date(checkDate);
                expectedDate.setDate(expectedDate.getDate() - streak);

                if (dateStr === expectedDate.toISOString().split('T')[0]) {
                    streak++;
                } else {
                    break;
                }
            }

            return streak;
        }

        function showAddProfile() {
            selectedAvatar = AVATARS[0];
            renderAvatarPicker();
            document.getElementById('nameInput').value = '';
            document.getElementById('addProfileModal').classList.add('active');
        }

        function closeAddProfile() {
            document.getElementById('addProfileModal').classList.remove('active');
        }

        function renderAvatarPicker() {
            const picker = document.getElementById('avatarPicker');
            let html = '';

            // Regular avatars (always available)
            html += AVATARS.map(avatar => `
                <div class="avatar-option ${avatar === selectedAvatar ? 'selected' : ''}"
                     onclick="selectAvatar('${avatar}')">${avatar}</div>
            `).join('');

            // Unlockable avatars - check if unlocked based on any existing profile's progress
            const bestProfile = profiles.reduce((best, p) => {
                const score = (p.totalCorrect || 0) + (p.currentTierIndex || 0) * 10 + countMasteredFacts(p);
                const bestScore = (best.totalCorrect || 0) + (best.currentTierIndex || 0) * 10 + countMasteredFacts(best);
                return score > bestScore ? p : best;
            }, profiles[0] || {});

            html += UNLOCKABLE_AVATARS.map(ua => {
                const unlocked = ua.check(bestProfile);
                if (unlocked) {
                    return `<div class="avatar-option ${ua.emoji === selectedAvatar ? 'selected' : ''}"
                         onclick="selectAvatar('${ua.emoji}')" title="${ua.name}">${ua.emoji}</div>`;
                } else {
                    return `<div class="avatar-option locked" title="${ua.requirement}">üîí</div>`;
                }
            }).join('');

            picker.innerHTML = html;
        }

        function selectAvatar(avatar) {
            // Check if it's an unlockable avatar and if it's unlocked
            const unlockable = UNLOCKABLE_AVATARS.find(ua => ua.emoji === avatar);
            if (unlockable) {
                const bestProfile = profiles.reduce((best, p) => {
                    const score = (p.totalCorrect || 0) + (p.currentTierIndex || 0) * 10;
                    const bestScore = (best.totalCorrect || 0) + (best.currentTierIndex || 0) * 10;
                    return score > bestScore ? p : best;
                }, profiles[0] || {});

                if (!unlockable.check(bestProfile)) return; // Don't select locked avatar
            }

            selectedAvatar = avatar;
            renderAvatarPicker();
        }

        function saveNewProfile() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                document.getElementById('nameInput').focus();
                return;
            }

            const newProfile = {
                id: Date.now(),
                name: name,
                avatar: selectedAvatar,
                currentTierIndex: 0,
                factProgress: {}, // { "3+2": { correct: 5, wrong: 1, lastSeen: timestamp, mastered: true } }
                totalCorrect: 0,
                totalSessions: 0,
                dailyProgress: {} // { "2024-01-15": 12 }
            };

            profiles.push(newProfile);
            saveProfiles();
            closeAddProfile();
            renderProfiles();
        }

        // ============================================
        // PROFILE SELECTION & GAME START
        // ============================================
        function selectProfile(index) {
            currentProfile = profiles[index];
            startPracticeSession();
        }

        function startPracticeSession() {
            // Update UI
            document.getElementById('currentAvatar').textContent = currentProfile.avatar;
            document.getElementById('currentName').textContent = currentProfile.name;

            updateTierDisplay();

            // Show practice screen
            showScreen('practiceScreen');

            // Start Pomodoro timer
            startPomodoro();

            // Generate first problem
            generateProblem();
        }

        function getCurrentTier(profile) {
            return TIERS[profile.currentTierIndex] || TIERS[0];
        }

        function getMasteredCount(profile, tier) {
            if (!tier) return 0;
            let count = 0;
            tier.facts.forEach(fact => {
                const key = fact.display;
                const progress = profile.factProgress[key];
                if (progress && progress.mastered) count++;
            });
            return count;
        }

        function updateTierDisplay() {
            const tier = getCurrentTier(currentProfile);
            const mastered = getMasteredCount(currentProfile, tier);
            const total = tier.facts.length;
            const percent = Math.round((mastered / total) * 100);

            document.getElementById('currentTier').textContent = tier.name;
            document.getElementById('tierName').textContent = tier.name;
            document.getElementById('tierCount').textContent = `${mastered}/${total} mastered`;
            document.getElementById('tierFill').style.width = `${percent}%`;
        }

        // ============================================
        // PROBLEM GENERATION - Smart Selection
        // ============================================
        function generateProblem() {
            const tier = getCurrentTier(currentProfile);
            currentFact = selectSmartFact(tier);

            document.getElementById('problem').textContent = currentFact.display;
            currentInput = '';
            updateAnswerDisplay();
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';
            document.getElementById('answerBox').className = 'answer-box';

            // Hide previous hint
            hideHint();

            // Show hints for certain problem types
            const hintEl = document.getElementById('problemHint');
            const hints = {
                'compare': 'Type the bigger number',
                'tens': 'How many tens?',
                'ones': 'How many ones?',
                'build': 'Build the number',
                'half': 'Find the fraction',
                'quarter': 'Find the fraction',
                'third': 'Find the fraction',
                'skip': 'What comes next?',
                'bond': 'Find the pair',
                'evenodd': '0 = even, 1 = odd',
                '√ó?': 'Find the missing number',
                'round10': 'Round to nearest 10',
                'before': 'What comes before?',
                'after': 'What comes after?',
                'expanded': 'Find the ones',
                'family': 'Use the fact family',
                'gtlt': '1 = less than (<), 2 = greater than (>)',
                'wordadd': 'Add to find total',
                'wordsub': 'Subtract to find remainder',
                'clock': 'What hour?',
                'clockhalf': 'What minutes? (30)',
                'clockquarter': 'What minutes? (15 or 45)',
                'coins': 'Count the cents',
                'mixedcoins': 'Add up all the coins',
                'shapesides': 'Count the sides',
                'pattern': 'Find the pattern',
                'neardouble': 'Double + 1',
                'order': 'Find the middle number'
            };

            if (hints[currentFact.op]) {
                hintEl.textContent = hints[currentFact.op];
                hintEl.style.display = 'block';
            } else {
                hintEl.style.display = 'none';
            }

            // Audio/Visual aids
            renderDots(currentFact);
            speakProblem(currentFact);
        }

        function selectSmartFact(tier) {
            const facts = tier.facts;
            const learning = [];
            const mastered = [];
            const newFacts = [];

            facts.forEach(fact => {
                const key = fact.display;
                const progress = currentProfile.factProgress[key];

                if (!progress || progress.correct === 0) {
                    newFacts.push(fact);
                } else if (progress.mastered) {
                    mastered.push(fact);
                } else {
                    learning.push(fact);
                }
            });

            // Priority: 70% learning, 20% mastered (review), 10% new
            const rand = Math.random();
            let pool;

            if (rand < 0.7 && learning.length > 0) {
                pool = learning;
            } else if (rand < 0.9 && mastered.length > 0) {
                pool = mastered;
            } else if (newFacts.length > 0) {
                pool = newFacts;
            } else if (learning.length > 0) {
                pool = learning;
            } else {
                pool = mastered.length > 0 ? mastered : facts;
            }

            // Weight by recency and errors
            pool.sort((a, b) => {
                const pa = currentProfile.factProgress[a.display] || { correct: 0, wrong: 0, lastSeen: 0 };
                const pb = currentProfile.factProgress[b.display] || { correct: 0, wrong: 0, lastSeen: 0 };

                // Prioritize facts with more errors
                const errorDiff = pb.wrong - pa.wrong;
                if (errorDiff !== 0) return errorDiff;

                // Then by least recently seen
                return pa.lastSeen - pb.lastSeen;
            });

            // Pick from top 3 with some randomness
            const topN = Math.min(3, pool.length);
            return pool[Math.floor(Math.random() * topN)];
        }

        // ============================================
        // INPUT & ANSWER CHECKING
        // ============================================
        function numPress(num) {
            if (currentInput.length >= 3) return;
            currentInput += num;
            updateAnswerDisplay();
            playSound('tap');
        }

        function clearInput() {
            currentInput = currentInput.slice(0, -1);
            updateAnswerDisplay();
            playSound('tap');
        }

        function updateAnswerDisplay() {
            document.getElementById('answerBox').textContent = currentInput || '|';
        }

        function checkAnswer() {
            if (!currentInput || !currentFact) return;

            const userAnswer = parseInt(currentInput);
            const isCorrect = userAnswer === currentFact.answer;
            const key = currentFact.display;

            // Initialize progress if needed
            if (!currentProfile.factProgress[key]) {
                currentProfile.factProgress[key] = { correct: 0, wrong: 0, lastSeen: 0, mastered: false };
            }

            const progress = currentProfile.factProgress[key];
            progress.lastSeen = Date.now();

            if (isCorrect) {
                handleCorrectAnswer(progress, key);
            } else {
                handleWrongAnswer(progress, key);
            }

            // Timed mode: fast transitions, no daily tracking
            if (timedMode) {
                if (isCorrect) timedModeScore++;
                saveProfiles();
                // Immediate next problem in timed mode
                setTimeout(generateProblem, isCorrect ? 300 : 800);
                return;
            }

            // Update daily progress (for streak tracking)
            const today = new Date().toISOString().split('T')[0];
            currentProfile.dailyProgress[today] = (currentProfile.dailyProgress[today] || 0) + 1;

            // Check achievements
            const newAchievements = checkAchievements(currentProfile);
            if (newAchievements.length > 0) {
                setTimeout(() => showAchievementPopup(newAchievements[0]), 1600);
            }

            saveProfiles();
            if (!reviewMode) updateTierDisplay();

            // Continue with next problem
            const nextFn = reviewMode ? generateReviewProblem : generateProblem;
            setTimeout(nextFn, isCorrect ? 800 : 2000);
        }

        function handleCorrectAnswer(progress, key) {
            sessionStats.correct++;
            sessionStats.correctStreak++;
            progress.correct++;

            // Track total correct and best streak for achievements
            currentProfile.totalCorrect = (currentProfile.totalCorrect || 0) + 1;
            if (sessionStats.correctStreak > (currentProfile.bestStreak || 0)) {
                currentProfile.bestStreak = sessionStats.correctStreak;
            }

            document.getElementById('answerBox').classList.add('correct');
            document.getElementById('feedback').textContent = '‚úì Correct!';
            document.getElementById('feedback').className = 'feedback correct';

            playSound('correct');
            speakFeedback(true, null, currentFact);

            // Check for mastery (4 correct with < 30% error rate)
            const errorRate = progress.wrong / (progress.correct + progress.wrong);
            if (!progress.mastered && progress.correct >= 4 && errorRate < 0.3) {
                progress.mastered = true;
                sessionStats.newlyMastered.push(key);
                document.getElementById('feedback').textContent = '‚≠ê Mastered!';
                playSound('mastered');

                // Update mastery display and check if goal reached
                if (pomodoroActive) updateMasteryDisplay();

                // Check for tier advancement (skip in review mode)
                if (!reviewMode) checkTierAdvancement();
            }
        }

        function handleWrongAnswer(progress, key) {
            sessionStats.wrong++;
            sessionStats.correctStreak = 0; // Reset streak on wrong answer
            progress.wrong++;

            // If was mastered, might need to un-master with too many errors
            if (progress.mastered) {
                const errorRate = progress.wrong / (progress.correct + progress.wrong);
                if (errorRate > 0.3) {
                    progress.mastered = false;
                }
            }

            if (!sessionStats.needsPractice.includes(key)) {
                sessionStats.needsPractice.push(key);
            }

            document.getElementById('answerBox').classList.add('wrong');

            // Special display for certain types
            let answerText = currentFact.answer;
            if (currentFact.op === 'evenodd') {
                answerText = currentFact.isOdd ? 'odd (1)' : 'even (0)';
            } else if (currentFact.op === 'gtlt') {
                answerText = currentFact.symbol === '<' ? '< (1)' : '> (2)';
            } else if (currentFact.op === 'clockhalf') {
                answerText = '30 (half past)';
            }

            document.getElementById('feedback').innerHTML = `
                <span class="correct-answer">The answer is ${answerText}</span>
            `;
            document.getElementById('feedback').className = 'feedback wrong';

            playSound('wrong');
            speakFeedback(false, currentFact.answer, currentFact);

            // Show hint button for next attempt
            currentHint = getHintForFact(currentFact);
            if (currentHint) {
                document.getElementById('hintBtn').style.display = 'inline-block';
            }
        }

        function checkTierAdvancement() {
            const tier = getCurrentTier(currentProfile);
            const mastered = getMasteredCount(currentProfile, tier);
            const total = tier.facts.length;
            const masteryRate = mastered / total;

            if (masteryRate >= tier.requiredMastery && currentProfile.currentTierIndex < TIERS.length - 1) {
                currentProfile.currentTierIndex++;
                saveProfiles();

                // Show celebration with confetti!
                showConfetti();
                const newTier = getCurrentTier(currentProfile);
                document.getElementById('tierUnlockName').textContent = newTier.name;
                document.getElementById('tierUnlock').classList.add('active');

                setTimeout(() => {
                    document.getElementById('tierUnlock').classList.remove('active');
                    updateTierDisplay();
                }, 3000);
            }
        }

        // ============================================
        // SESSION COMPLETE
        // ============================================
        function endPracticeSession() {
            // Stop Pomodoro timer
            stopPomodoro();

            // Stop any timed mode
            if (timedMode && timedModeTimer) {
                clearInterval(timedModeTimer);
                timedModeTimer = null;
                timedMode = false;
                document.getElementById('timerBar').style.display = 'none';
                document.querySelector('.tier-progress').style.display = 'block';
                document.getElementById('pomodoroSection').style.display = 'flex';
            }

            // If no problems attempted, just go back to profiles
            const total = sessionStats.correct + sessionStats.wrong;
            if (total === 0) {
                reviewMode = false;
                showProfiles();
                return;
            }

            // Show session summary
            showSessionComplete();
        }

        function showSessionComplete() {
            const total = sessionStats.correct + sessionStats.wrong;
            const accuracy = total > 0 ? Math.round((sessionStats.correct / total) * 100) : 0;

            document.getElementById('sessionCorrect').textContent = sessionStats.correct;
            document.getElementById('sessionAccuracy').textContent = accuracy + '%';

            // Show streak
            const streak = calculateStreak(currentProfile);
            document.getElementById('streakCount').textContent = streak;
            document.getElementById('streakLabel').textContent = 'Day Streak';
            document.getElementById('streakDisplay').style.display = streak > 0 ? 'flex' : 'none';

            // Reset accuracy label for normal mode
            document.getElementById('sessionAccuracyLabel').textContent = 'Accuracy';

            // Show mastered facts
            if (sessionStats.newlyMastered.length > 0) {
                document.getElementById('masteredSection').style.display = 'block';
                document.getElementById('masteredFacts').innerHTML = sessionStats.newlyMastered
                    .map(f => `<span class="mastered-fact">${f}</span>`).join('');
            } else {
                document.getElementById('masteredSection').style.display = 'none';
            }

            // Show needs practice
            if (sessionStats.needsPractice.length > 0) {
                document.getElementById('practiceMoreSection').style.display = 'block';
                document.getElementById('practiceFacts').innerHTML = sessionStats.needsPractice
                    .map(f => `<span class="practice-fact">${f}</span>`).join('');
            } else {
                document.getElementById('practiceMoreSection').style.display = 'none';
            }

            showScreen('sessionScreen');
        }

        function finishSession() {
            reviewMode = false;
            showProfiles();
        }

        // ============================================
        // PARENT VIEW
        // ============================================
        function showParentView(profileIndex) {
            const profile = profiles[profileIndex];
            const tier = getCurrentTier(profile);

            // Player name
            document.getElementById('parentPlayerName').innerHTML = `${profile.avatar} ${profile.name}`;

            // Stats
            const totalProblems = Object.values(profile.dailyProgress || {}).reduce((a, b) => a + b, 0);
            const masteredCount = getMasteredCount(profile, tier);
            const totalFacts = tier.facts.length;
            const streak = calculateStreak(profile);

            document.getElementById('parentStats').innerHTML = `
                <div class="parent-stat">
                    <div class="parent-stat-value">${totalProblems}</div>
                    <div class="parent-stat-label">Total Problems</div>
                </div>
                <div class="parent-stat">
                    <div class="parent-stat-value">${masteredCount}/${totalFacts}</div>
                    <div class="parent-stat-label">Facts Mastered</div>
                </div>
                <div class="parent-stat">
                    <div class="parent-stat-value">${streak}</div>
                    <div class="parent-stat-label">Day Streak</div>
                </div>
                <div class="parent-stat">
                    <div class="parent-stat-value">${tier.name}</div>
                    <div class="parent-stat-label">Current Level</div>
                </div>
            `;

            // Find struggling facts (wrong > 0, sorted by error rate)
            const struggles = [];
            for (const [fact, progress] of Object.entries(profile.factProgress || {})) {
                if (progress.wrong > 0) {
                    const total = progress.correct + progress.wrong;
                    const errorRate = Math.round((progress.wrong / total) * 100);
                    struggles.push({ fact, errorRate, wrong: progress.wrong, correct: progress.correct });
                }
            }
            struggles.sort((a, b) => b.errorRate - a.errorRate);

            if (struggles.length > 0) {
                document.getElementById('parentStruggles').innerHTML = `
                    <div class="parent-struggles-title">‚ö†Ô∏è Needs Practice (${struggles.length} facts)</div>
                    ${struggles.slice(0, 8).map(s => `
                        <div class="struggle-fact">
                            <span>${s.fact}</span>
                            <span class="struggle-rate">${s.errorRate}% errors</span>
                        </div>
                    `).join('')}
                    ${struggles.length > 8 ? `<div style="text-align:center;color:var(--text-dim);margin-top:10px;">+ ${struggles.length - 8} more</div>` : ''}
                `;
                document.getElementById('parentStruggles').style.display = 'block';
            } else {
                document.getElementById('parentStruggles').innerHTML = `
                    <div style="text-align:center;color:var(--success);">‚úì No struggling facts!</div>
                `;
            }

            document.getElementById('parentModal').classList.add('active');
        }

        function closeParentView() {
            document.getElementById('parentModal').classList.remove('active');
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showProfiles() {
            reviewMode = false;
            if (currentProfile && currentProfile._reviewFacts) {
                delete currentProfile._reviewFacts;
            }
            renderProfiles();
            showScreen('profileScreen');
        }

        // ============================================
        // KEYBOARD SUPPORT
        // ============================================
        document.addEventListener('keydown', function(e) {
            if (!document.getElementById('practiceScreen').classList.contains('active')) return;

            if (e.key >= '0' && e.key <= '9') numPress(e.key);
            else if (e.key === 'Backspace') { e.preventDefault(); clearInput(); }
            else if (e.key === 'Enter') checkAnswer();
        });

        // ============================================
        // ACHIEVEMENTS
        // ============================================
        function showAchievements(profileIndex) {
            const profile = profiles[profileIndex];
            if (!profile.achievements) profile.achievements = [];

            const list = document.getElementById('achievementsList');
            list.innerHTML = ACHIEVEMENTS.map(a => {
                const unlocked = profile.achievements.includes(a.id);
                return `
                    <div class="achievement-item ${unlocked ? '' : 'locked'}">
                        <div class="achievement-emoji">${a.emoji}</div>
                        <div class="achievement-info">
                            <div class="achievement-name">${a.name}</div>
                            <div class="achievement-desc">${a.desc}</div>
                        </div>
                        ${unlocked ? '‚úì' : 'üîí'}
                    </div>
                `;
            }).join('');

            document.getElementById('achievementsModal').classList.add('active');
        }

        function closeAchievements() {
            document.getElementById('achievementsModal').classList.remove('active');
        }

        function showAchievementPopup(achievement) {
            document.getElementById('achievementEmoji').textContent = achievement.emoji;
            document.getElementById('achievementName').textContent = achievement.name;
            document.getElementById('achievementDesc').textContent = achievement.desc;
            document.getElementById('achievementPopup').classList.add('active');

            // Celebration confetti!
            showConfetti();

            setTimeout(() => {
                document.getElementById('achievementPopup').classList.remove('active');
            }, 3000);
        }

        // ============================================
        // SETTINGS
        // ============================================
        function showSettings() {
            document.getElementById('settingsModal').classList.add('active');
            updateSettingsDisplay();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function setSessionLength(minutes) {
            pomodoroLength = minutes * 60;
            localStorage.setItem('nanana_pomodoroLength', minutes);
            updateSettingsDisplay();
        }

        function setMasteryGoal(goal) {
            masteryGoal = goal;
            localStorage.setItem('nanana_masteryGoal', goal);
            updateSettingsDisplay();
            // Update display if in practice
            document.getElementById('masteryGoalDisplay').textContent = goal;
        }

        function setBreakLength(minutes) {
            breakLength = minutes * 60;
            localStorage.setItem('nanana_breakLength', minutes);
            updateSettingsDisplay();
        }

        function updateSettingsDisplay() {
            // Session length buttons
            document.querySelectorAll('#sessionLengthOptions .goal-option').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === (pomodoroLength / 60) + ' min') {
                    btn.classList.add('active');
                }
            });

            // Mastery goal buttons
            document.querySelectorAll('#masteryGoalOptions .goal-option').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === masteryGoal.toString()) {
                    btn.classList.add('active');
                }
            });

            // Break length buttons
            document.querySelectorAll('#breakLengthOptions .goal-option').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === (breakLength / 60) + ' min') {
                    btn.classList.add('active');
                }
            });
        }

        function setTextSize(size) {
            if (size === 'large') {
                document.body.classList.add('large-text');
            } else {
                document.body.classList.remove('large-text');
            }
            localStorage.setItem('nanana_textSize', size);
        }

        // ============================================
        // REVIEW MODE
        // ============================================
        function startReviewMode(profileIndex) {
            currentProfile = profiles[profileIndex];
            reviewMode = true;

            // Collect all struggling facts from all tiers
            const struggles = [];
            for (const [fact, progress] of Object.entries(currentProfile.factProgress || {})) {
                if (progress.wrong > 0 && !progress.mastered) {
                    const errorRate = progress.wrong / (progress.correct + progress.wrong);
                    struggles.push({ display: fact, errorRate });
                }
            }

            if (struggles.length === 0) {
                alert('No struggling facts to review! Great job!');
                return;
            }

            // Store review facts
            currentProfile._reviewFacts = struggles.sort((a, b) => b.errorRate - a.errorRate);

            sessionStats = { correct: 0, wrong: 0, newlyMastered: [], needsPractice: [], correctStreak: 0 };

            document.getElementById('currentAvatar').textContent = currentProfile.avatar;
            document.getElementById('currentName').innerHTML = currentProfile.name + '<span class="review-badge">REVIEW</span>';
            document.getElementById('currentTier').textContent = `${struggles.length} facts to review`;
            document.getElementById('tierName').textContent = 'Review Mode';
            document.getElementById('tierCount').textContent = `${struggles.length} struggling facts`;
            document.getElementById('tierFill').style.width = '0%';

            updateDailyGoal();
            showScreen('practiceScreen');
            generateReviewProblem();
        }

        function generateReviewProblem() {
            if (!currentProfile._reviewFacts || currentProfile._reviewFacts.length === 0) {
                showSessionComplete();
                return;
            }

            // Pick from struggling facts
            const idx = Math.floor(Math.random() * Math.min(5, currentProfile._reviewFacts.length));
            const factDisplay = currentProfile._reviewFacts[idx].display;

            // Find the actual fact object
            for (const tier of TIERS) {
                for (const fact of tier.facts) {
                    if (fact.display === factDisplay) {
                        currentFact = fact;
                        break;
                    }
                }
                if (currentFact && currentFact.display === factDisplay) break;
            }

            if (!currentFact) {
                currentProfile._reviewFacts.splice(idx, 1);
                generateReviewProblem();
                return;
            }

            document.getElementById('problem').textContent = currentFact.display;
            currentInput = '';
            updateAnswerDisplay();
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';
            document.getElementById('answerBox').className = 'answer-box';

            // Hide previous hint
            hideHint();

            const hintEl = document.getElementById('problemHint');
            hintEl.textContent = 'Review: ' + (currentProfile.factProgress[factDisplay] ?
                `${currentProfile.factProgress[factDisplay].wrong} errors` : '');
            hintEl.style.display = 'block';

            renderDots(currentFact);
            speakProblem(currentFact);
        }

        // ============================================
        // INIT
        // ============================================
        // Load saved Pomodoro settings
        const savedPomodoroLength = localStorage.getItem('nanana_pomodoroLength');
        if (savedPomodoroLength) pomodoroLength = parseInt(savedPomodoroLength) * 60;

        const savedMasteryGoal = localStorage.getItem('nanana_masteryGoal');
        if (savedMasteryGoal) masteryGoal = parseInt(savedMasteryGoal);

        const savedBreakLength = localStorage.getItem('nanana_breakLength');
        if (savedBreakLength) breakLength = parseInt(savedBreakLength) * 60;

        const savedTextSize = localStorage.getItem('nanana_textSize');
        if (savedTextSize === 'large') document.body.classList.add('large-text');

        loadProfiles();
    </script>
</body>
</html>
