<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nanana Math">
    <meta name="theme-color" content="#1a0a2e">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Nanana Math</title>
    <style>
        :root {
            --bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --primary: #ffd93d;
            --accent: #ff6b9d;
            --success: #6bcb77;
            --error: #ff6b6b;
            --card-bg: rgba(255, 255, 255, 0.05);
            --text: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.6);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            height: -webkit-fill-available;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100%;
            min-height: -webkit-fill-available;
            padding: 15px;
            padding-top: max(15px, env(safe-area-inset-top));
            padding-bottom: max(15px, env(safe-area-inset-bottom));
        }

        /* Screens */
        .screen {
            display: none;
            width: 100%;
            max-width: 400px;
            flex-direction: column;
            gap: 20px;
        }
        .screen.active { display: flex; }

        /* Profile Selection Screen */
        .app-title {
            font-size: 2.5rem;
            font-weight: 800;
            text-align: center;
            color: var(--primary);
            text-shadow: 0 0 30px var(--primary);
            margin-bottom: 10px;
        }
        .app-subtitle {
            text-align: center;
            color: var(--text-dim);
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .profiles-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .profile-card {
            background: var(--card-bg);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .profile-card:hover, .profile-card:active {
            border-color: var(--primary);
            transform: scale(1.02);
            background: rgba(255, 215, 61, 0.1);
        }
        .profile-card.add-new {
            border-style: dashed;
            opacity: 0.6;
        }
        .profile-card.add-new:hover {
            opacity: 1;
            border-color: var(--accent);
        }

        .profile-avatar {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        .profile-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .profile-level {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        /* Practice Screen */
        .practice-container {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .practice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .player-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .player-avatar { font-size: 2rem; }
        .player-name { font-weight: 600; font-size: 1.1rem; }
        .player-tier { font-size: 0.8rem; color: var(--primary); }

        .back-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        /* Progress Section */
        .tier-progress {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .tier-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .tier-name { color: var(--primary); font-weight: 600; }
        .tier-count { color: var(--text-dim); }

        .tier-bar {
            height: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            overflow: hidden;
        }
        .tier-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        /* Daily Goal */
        .daily-goal {
            text-align: center;
            padding: 15px;
            background: rgba(255, 215, 61, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .goal-label { font-size: 0.85rem; color: var(--text-dim); }
        .goal-progress {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin: 5px 0;
        }
        .goal-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        .goal-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.3s;
        }

        /* Audio Controls */
        .audio-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .audio-btn {
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            font-size: 1.3rem;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.2s;
        }
        .audio-btn.active {
            opacity: 1;
            border-color: var(--primary);
            background: rgba(255, 215, 61, 0.2);
        }

        /* Problem Area */
        .problem-area {
            text-align: center;
            padding: 20px;
        }

        /* Counting Dots */
        .dots-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            min-height: 50px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .dot-group {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            max-width: 120px;
        }
        .dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            box-shadow: 0 0 8px var(--primary);
        }
        .dot.second {
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }
        .dots-operator {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-dim);
        }
        .dots-equals {
            font-size: 1.5rem;
            color: var(--text-dim);
        }
        .dots-result {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dim);
            min-width: 30px;
        }

        .problem {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 20px;
            letter-spacing: 4px;
        }
        .answer-box {
            font-size: 2.5rem;
            font-weight: 600;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 15px 30px;
            min-width: 120px;
            display: inline-block;
            min-height: 70px;
        }
        .answer-box.correct {
            border-color: var(--success);
            background: rgba(107, 203, 119, 0.2);
        }
        .answer-box.wrong {
            border-color: var(--error);
            background: rgba(255, 107, 107, 0.2);
        }

        .feedback {
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            margin-top: 15px;
        }
        .feedback.correct { color: var(--success); }
        .feedback.wrong { color: var(--error); }
        .correct-answer {
            font-weight: 600;
            font-size: 1.2rem;
        }

        /* Numpad */
        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .numpad button {
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            font-size: 1.8rem;
            font-weight: 600;
            padding: 18px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        .numpad button:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.1);
        }
        .numpad .go-btn {
            background: var(--success);
            color: #000;
        }
        .numpad .go-btn:active {
            background: #5ab868;
        }

        /* Session Complete Screen */
        .session-complete {
            text-align: center;
        }
        .session-emoji {
            font-size: 4rem;
            margin-bottom: 15px;
        }
        .session-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 25px;
        }

        .session-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-box {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px 15px;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-top: 5px;
        }

        .mastered-section {
            background: rgba(107, 203, 119, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .mastered-title {
            color: var(--success);
            font-weight: 600;
            margin-bottom: 10px;
        }
        .mastered-facts {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .mastered-fact {
            background: var(--success);
            color: #000;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .practice-section {
            background: rgba(255, 215, 61, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .practice-title {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 10px;
        }
        .practice-facts {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .practice-fact {
            background: rgba(255, 215, 61, 0.3);
            color: var(--text);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .done-btn {
            background: var(--primary);
            color: #000;
            border: none;
            font-size: 1.2rem;
            font-weight: 700;
            padding: 18px 50px;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .done-btn:active {
            transform: scale(0.97);
        }

        /* Session buttons */
        .session-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .continue-btn {
            background: var(--success);
            color: #000;
            border: none;
            font-size: 1.2rem;
            font-weight: 700;
            padding: 18px 50px;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .continue-btn:active {
            transform: scale(0.97);
        }

        /* Day Streak */
        .streak-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 12px 20px;
            background: rgba(255, 107, 107, 0.15);
            border-radius: 25px;
        }
        .streak-fire { font-size: 1.5rem; }
        .streak-count {
            font-size: 1.8rem;
            font-weight: 800;
            color: #ff6b6b;
        }
        .streak-label {
            font-size: 1rem;
            color: var(--text-dim);
        }

        /* Profile card streak */
        .profile-streak {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #ff6b6b;
        }

        /* Parent View */
        .parent-view {
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .parent-player {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .parent-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .parent-stat {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        .parent-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        .parent-stat-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 4px;
        }
        .parent-struggles {
            background: rgba(255, 107, 107, 0.1);
            border-radius: 15px;
            padding: 15px;
        }
        .parent-struggles-title {
            color: var(--error);
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .struggle-fact {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem;
        }
        .struggle-fact:last-child { border-bottom: none; }
        .struggle-rate { color: var(--error); font-weight: 600; }

        /* Parent button on profile card */
        .parent-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            opacity: 0.4;
            padding: 5px;
        }
        .parent-btn:hover { opacity: 1; }
        .profile-card { position: relative; }

        /* Add Profile Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 100;
        }
        .modal.active { display: flex; }

        .modal-content {
            background: #1a1a2e;
            border-radius: 25px;
            padding: 30px;
            width: 100%;
            max-width: 350px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 25px;
        }

        .avatar-picker {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }
        .avatar-option {
            font-size: 2.5rem;
            padding: 10px;
            border: 3px solid transparent;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        .avatar-option.selected {
            border-color: var(--primary);
            background: rgba(255, 215, 61, 0.2);
        }

        .name-input {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 1.2rem;
            color: var(--text);
            text-align: center;
            margin-bottom: 25px;
        }
        .name-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .name-input::placeholder {
            color: var(--text-dim);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
        }
        .modal-btn {
            flex: 1;
            padding: 15px;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        .modal-btn.cancel {
            background: rgba(255,255,255,0.1);
            color: var(--text);
        }
        .modal-btn.confirm {
            background: var(--primary);
            color: #000;
        }

        /* Tier unlock celebration */
        .tier-unlock {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 200;
            flex-direction: column;
            gap: 20px;
            text-align: center;
            padding: 20px;
        }
        .tier-unlock.active { display: flex; }
        .tier-unlock-emoji { font-size: 5rem; }
        .tier-unlock-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 700;
        }
        .tier-unlock-name {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text);
        }
    </style>
</head>
<body>

    <!-- Profile Selection Screen -->
    <div class="screen active" id="profileScreen">
        <div class="app-title">Nanana Math</div>
        <div class="app-subtitle">Build strong math foundations</div>
        <div class="profiles-grid" id="profilesGrid"></div>
    </div>

    <!-- Practice Screen -->
    <div class="screen" id="practiceScreen">
        <div class="practice-container">
            <div class="practice-header">
                <div class="player-info">
                    <div class="player-avatar" id="currentAvatar">ü¶ä</div>
                    <div>
                        <div class="player-name" id="currentName">Player</div>
                        <div class="player-tier" id="currentTier">Addition to 5</div>
                    </div>
                </div>
                <button class="back-btn" onclick="showProfiles()">‚úï</button>
            </div>

            <div class="tier-progress">
                <div class="tier-label">
                    <span class="tier-name" id="tierName">Addition to 5</span>
                    <span class="tier-count" id="tierCount">0/10 mastered</span>
                </div>
                <div class="tier-bar">
                    <div class="tier-fill" id="tierFill" style="width: 0%"></div>
                </div>
            </div>

            <div class="daily-goal">
                <div class="goal-label">Today's Goal</div>
                <div class="goal-progress"><span id="goalCurrent">0</span> / <span id="goalTarget">10</span></div>
                <div class="goal-bar">
                    <div class="goal-fill" id="goalFill" style="width: 0%"></div>
                </div>
            </div>

            <div class="audio-controls">
                <button class="audio-btn active" id="soundBtn" onclick="toggleSound()" title="Sound effects">üîä</button>
                <button class="audio-btn active" id="speakBtn" onclick="toggleSpeak()" title="Read aloud">üó£Ô∏è</button>
                <button class="audio-btn active" id="dotsBtn" onclick="toggleDots()" title="Show counting dots">üëÅÔ∏è</button>
            </div>

            <div class="problem-area">
                <div class="dots-container" id="dotsContainer"></div>
                <div class="problem" id="problem">3 + 2</div>
                <div class="answer-box" id="answerBox">|</div>
                <div class="feedback" id="feedback"></div>
            </div>

            <div class="numpad">
                <button onclick="numPress(1)">1</button>
                <button onclick="numPress(2)">2</button>
                <button onclick="numPress(3)">3</button>
                <button onclick="numPress(4)">4</button>
                <button onclick="numPress(5)">5</button>
                <button onclick="numPress(6)">6</button>
                <button onclick="numPress(7)">7</button>
                <button onclick="numPress(8)">8</button>
                <button onclick="numPress(9)">9</button>
                <button onclick="clearInput()">‚Üê</button>
                <button onclick="numPress(0)">0</button>
                <button class="go-btn" onclick="checkAnswer()">GO</button>
            </div>
        </div>
    </div>

    <!-- Session Complete Screen -->
    <div class="screen" id="sessionScreen">
        <div class="practice-container session-complete">
            <div class="session-emoji">üåü</div>
            <div class="session-title">Great Practice!</div>

            <div class="streak-display" id="streakDisplay">
                <span class="streak-fire">üî•</span>
                <span class="streak-count" id="streakCount">1</span>
                <span class="streak-label">day streak!</span>
            </div>

            <div class="session-stats">
                <div class="stat-box">
                    <div class="stat-value" id="sessionCorrect">0</div>
                    <div class="stat-label">Correct</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="sessionAccuracy">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
            </div>

            <div class="mastered-section" id="masteredSection" style="display:none;">
                <div class="mastered-title">‚≠ê Newly Mastered!</div>
                <div class="mastered-facts" id="masteredFacts"></div>
            </div>

            <div class="practice-section" id="practiceMoreSection" style="display:none;">
                <div class="practice-title">üìù Keep Practicing</div>
                <div class="practice-facts" id="practiceFacts"></div>
            </div>

            <div class="session-buttons">
                <button class="continue-btn" onclick="continuePractice()">Keep Going!</button>
                <button class="done-btn" onclick="showProfiles()">Done</button>
            </div>
        </div>
    </div>

    <!-- Parent View Modal -->
    <div class="modal" id="parentModal">
        <div class="modal-content parent-view">
            <div class="modal-title">üìä Progress Report</div>
            <div class="parent-player" id="parentPlayerName"></div>
            <div class="parent-stats" id="parentStats"></div>
            <div class="parent-struggles" id="parentStruggles"></div>
            <button class="modal-btn confirm" onclick="closeParentView()" style="width:100%;margin-top:20px;">Close</button>
        </div>
    </div>

    <!-- Add Profile Modal -->
    <div class="modal" id="addProfileModal">
        <div class="modal-content">
            <div class="modal-title">New Player</div>
            <div class="avatar-picker" id="avatarPicker"></div>
            <input type="text" class="name-input" id="nameInput" placeholder="Enter name" maxlength="12">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeAddProfile()">Cancel</button>
                <button class="modal-btn confirm" onclick="saveNewProfile()">Create</button>
            </div>
        </div>
    </div>

    <!-- Tier Unlock Celebration -->
    <div class="tier-unlock" id="tierUnlock">
        <div class="tier-unlock-emoji">üéâ</div>
        <div class="tier-unlock-title">NEW SKILL UNLOCKED!</div>
        <div class="tier-unlock-name" id="tierUnlockName">Subtraction to 5</div>
    </div>

    <script>
        // ============================================
        // SKILL TIERS - Progression System
        // ============================================
        const TIERS = [
            {
                id: 'add5',
                name: 'Addition to 5',
                facts: generateAdditionFacts(5),
                requiredMastery: 0.9
            },
            {
                id: 'add10',
                name: 'Addition to 10',
                facts: generateAdditionFacts(10),
                requiredMastery: 0.9
            },
            {
                id: 'sub5',
                name: 'Subtraction to 5',
                facts: generateSubtractionFacts(5),
                requiredMastery: 0.9
            },
            {
                id: 'sub10',
                name: 'Subtraction to 10',
                facts: generateSubtractionFacts(10),
                requiredMastery: 0.9
            },
            {
                id: 'add20',
                name: 'Addition to 20',
                facts: generateAdditionFacts(20),
                requiredMastery: 0.9
            },
            {
                id: 'sub20',
                name: 'Subtraction to 20',
                facts: generateSubtractionFacts(20),
                requiredMastery: 0.9
            },
            {
                id: 'doubles',
                name: 'Doubles',
                facts: generateDoublesFacts(),
                requiredMastery: 0.9
            },
            {
                id: 'mult2',
                name: 'Multiply by 2',
                facts: generateMultiplicationFacts(2),
                requiredMastery: 0.9
            },
            {
                id: 'mult5',
                name: 'Multiply by 5',
                facts: generateMultiplicationFacts(5),
                requiredMastery: 0.9
            },
            {
                id: 'mult10',
                name: 'Multiply by 10',
                facts: generateMultiplicationFacts(10),
                requiredMastery: 0.9
            },
            {
                id: 'missing_add10',
                name: 'Missing Number +',
                facts: generateMissingAdditionFacts(10),
                requiredMastery: 0.9
            },
            {
                id: 'mult3',
                name: 'Multiply by 3',
                facts: generateMultiplicationFacts(3),
                requiredMastery: 0.9
            },
            {
                id: 'mult4',
                name: 'Multiply by 4',
                facts: generateMultiplicationFacts(4),
                requiredMastery: 0.9
            },
            {
                id: 'div2',
                name: 'Divide by 2',
                facts: generateDivisionFacts(2),
                requiredMastery: 0.9
            },
            {
                id: 'div5',
                name: 'Divide by 5',
                facts: generateDivisionFacts(5),
                requiredMastery: 0.9
            },
            {
                id: 'div10',
                name: 'Divide by 10',
                facts: generateDivisionFacts(10),
                requiredMastery: 0.9
            },
            {
                id: 'mult6',
                name: 'Multiply by 6',
                facts: generateMultiplicationFacts(6),
                requiredMastery: 0.9
            },
            {
                id: 'mult7',
                name: 'Multiply by 7',
                facts: generateMultiplicationFacts(7),
                requiredMastery: 0.9
            },
            {
                id: 'mult8',
                name: 'Multiply by 8',
                facts: generateMultiplicationFacts(8),
                requiredMastery: 0.9
            },
            {
                id: 'mult9',
                name: 'Multiply by 9',
                facts: generateMultiplicationFacts(9),
                requiredMastery: 0.9
            },
            {
                id: 'div3',
                name: 'Divide by 3',
                facts: generateDivisionFacts(3),
                requiredMastery: 0.9
            },
            {
                id: 'div4',
                name: 'Divide by 4',
                facts: generateDivisionFacts(4),
                requiredMastery: 0.9
            },
            {
                id: 'missing_sub10',
                name: 'Missing Number ‚àí',
                facts: generateMissingSubtractionFacts(10),
                requiredMastery: 0.9
            }
        ];

        // Generate fact sets (no trivial 0+x or x+0 facts)
        function generateAdditionFacts(max) {
            const facts = [];
            for (let a = 1; a <= max; a++) {
                for (let b = 1; b <= max - a; b++) {
                    if (a + b <= max) {
                        facts.push({ a, b, op: '+', answer: a + b, display: `${a} + ${b}` });
                    }
                }
            }
            return facts;
        }

        function generateSubtractionFacts(max) {
            const facts = [];
            for (let a = 2; a <= max; a++) {
                // Start b at 1 to avoid trivial x-0 facts
                for (let b = 1; b < a; b++) {
                    facts.push({ a, b, op: '-', answer: a - b, display: `${a} ‚àí ${b}` });
                }
            }
            return facts;
        }

        function generateDoublesFacts() {
            const facts = [];
            for (let a = 1; a <= 10; a++) {
                facts.push({ a, b: a, op: '+', answer: a + a, display: `${a} + ${a}` });
            }
            return facts;
        }

        function generateMultiplicationFacts(multiplier) {
            const facts = [];
            // Start at 1 to avoid trivial 0√óx facts
            for (let a = 1; a <= 10; a++) {
                facts.push({ a, b: multiplier, op: '√ó', answer: a * multiplier, display: `${a} √ó ${multiplier}` });
            }
            return facts;
        }

        function generateDivisionFacts(divisor) {
            const facts = [];
            // Generate division facts from multiplication (e.g., 6√∑2=3 from 2√ó3=6)
            for (let a = 1; a <= 10; a++) {
                const dividend = a * divisor;
                facts.push({ a: dividend, b: divisor, op: '√∑', answer: a, display: `${dividend} √∑ ${divisor}` });
            }
            return facts;
        }

        function generateMissingAdditionFacts(max) {
            const facts = [];
            // Problems like: 3 + ? = 7 (answer is 4)
            for (let sum = 3; sum <= max; sum++) {
                for (let a = 1; a < sum; a++) {
                    const missing = sum - a;
                    if (missing >= 1) {
                        facts.push({
                            a,
                            b: missing,
                            op: '+?',
                            answer: missing,
                            display: `${a} + ? = ${sum}`,
                            sum: sum
                        });
                    }
                }
            }
            return facts;
        }

        function generateMissingSubtractionFacts(max) {
            const facts = [];
            // Problems like: 7 ‚àí ? = 3 (answer is 4)
            for (let a = 3; a <= max; a++) {
                for (let result = 1; result < a; result++) {
                    const missing = a - result;
                    if (missing >= 1) {
                        facts.push({
                            a,
                            b: missing,
                            op: '-?',
                            answer: missing,
                            display: `${a} ‚àí ? = ${result}`,
                            result: result
                        });
                    }
                }
            }
            return facts;
        }

        // ============================================
        // DATA STORAGE
        // ============================================
        const AVATARS = ['ü¶ä', 'üêº', 'ü¶Å', 'üê∏', 'üê±', 'üê∂', 'ü¶Ñ', 'üê∞'];

        let profiles = [];
        let currentProfile = null;
        let currentInput = '';
        let currentFact = null;
        let sessionStats = { correct: 0, wrong: 0, newlyMastered: [], needsPractice: [] };
        let dailyGoal = 10;
        let selectedAvatar = 'ü¶ä';

        // Audio/Visual settings
        let soundEnabled = true;
        let speakEnabled = true;
        let dotsEnabled = true;
        let audioContext = null;

        // ============================================
        // SOUND EFFECTS
        // ============================================
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(type) {
            if (!soundEnabled) return;
            initAudio();

            const oscillator = audioContext.createOscillator();
            const gain = audioContext.createGain();
            oscillator.connect(gain);
            gain.connect(audioContext.destination);

            if (type === 'tap') {
                oscillator.frequency.value = 600;
                gain.gain.value = 0.1;
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.05);
            } else if (type === 'correct') {
                oscillator.frequency.value = 523; // C5
                gain.gain.value = 0.15;
                oscillator.start();
                setTimeout(() => oscillator.frequency.value = 659, 100); // E5
                setTimeout(() => oscillator.frequency.value = 784, 200); // G5
                oscillator.stop(audioContext.currentTime + 0.35);
            } else if (type === 'wrong') {
                oscillator.frequency.value = 200;
                gain.gain.value = 0.15;
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.3);
            } else if (type === 'mastered') {
                oscillator.frequency.value = 523;
                gain.gain.value = 0.15;
                oscillator.start();
                setTimeout(() => oscillator.frequency.value = 659, 100);
                setTimeout(() => oscillator.frequency.value = 784, 200);
                setTimeout(() => oscillator.frequency.value = 1047, 300);
                oscillator.stop(audioContext.currentTime + 0.5);
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundBtn').classList.toggle('active', soundEnabled);
            if (soundEnabled) playSound('tap');
        }

        // ============================================
        // SPEECH SYNTHESIS (Read Aloud)
        // ============================================
        function speakProblem(fact) {
            if (!speakEnabled || !('speechSynthesis' in window)) return;

            // Cancel any ongoing speech
            speechSynthesis.cancel();

            // Build the sentence
            let text = '';
            if (fact.op === '+') {
                text = `What is ${fact.a} plus ${fact.b}?`;
            } else if (fact.op === '-' || fact.op === '‚àí') {
                text = `What is ${fact.a} minus ${fact.b}?`;
            } else if (fact.op === '√ó') {
                text = `What is ${fact.a} times ${fact.b}?`;
            } else if (fact.op === '√∑') {
                text = `What is ${fact.a} divided by ${fact.b}?`;
            } else if (fact.op === '+?') {
                text = `${fact.a} plus what equals ${fact.sum}?`;
            } else if (fact.op === '-?') {
                text = `${fact.a} minus what equals ${fact.result}?`;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.1;
            speechSynthesis.speak(utterance);
        }

        function speakFeedback(correct, answer) {
            if (!speakEnabled || !('speechSynthesis' in window)) return;

            speechSynthesis.cancel();

            const text = correct ? 'Correct!' : `The answer is ${answer}`;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.1;
            speechSynthesis.speak(utterance);
        }

        function toggleSpeak() {
            speakEnabled = !speakEnabled;
            document.getElementById('speakBtn').classList.toggle('active', speakEnabled);
            if (speakEnabled && currentFact) speakProblem(currentFact);
        }

        // ============================================
        // COUNTING DOTS
        // ============================================
        function renderDots(fact) {
            const container = document.getElementById('dotsContainer');

            // Skip dots for multiplication/division (too many) or large numbers
            if (!dotsEnabled || !fact) {
                container.innerHTML = '';
                return;
            }

            // Skip dots for multiplication, division, or numbers > 12
            if (fact.op === '√ó' || fact.op === '√∑' || fact.a > 12 || fact.b > 12) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            // Standard addition: show two groups
            if (fact.op === '+') {
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.a; i++) html += '<div class="dot"></div>';
                html += '</div>';
                html += '<div class="dots-operator">+</div>';
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.b; i++) html += '<div class="dot second"></div>';
                html += '</div>';
            }
            // Subtraction: show crossed out dots
            else if (fact.op === '-' || fact.op === '‚àí') {
                html = '<div class="dot-group">';
                for (let i = 0; i < fact.a; i++) {
                    if (i < fact.b) {
                        html += '<div class="dot" style="opacity:0.3;"></div>';
                    } else {
                        html += '<div class="dot"></div>';
                    }
                }
                html += '</div>';
            }
            // Missing addition: show known + ? = total
            else if (fact.op === '+?') {
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.a; i++) html += '<div class="dot"></div>';
                html += '</div>';
                html += '<div class="dots-operator">+</div>';
                html += '<div class="dots-result">?</div>';
                html += '<div class="dots-equals">=</div>';
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.sum; i++) html += '<div class="dot" style="opacity:0.5;"></div>';
                html += '</div>';
            }
            // Missing subtraction: show total - ? = result
            else if (fact.op === '-?') {
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.a; i++) html += '<div class="dot"></div>';
                html += '</div>';
                html += '<div class="dots-operator">‚àí</div>';
                html += '<div class="dots-result">?</div>';
                html += '<div class="dots-equals">=</div>';
                html += '<div class="dot-group">';
                for (let i = 0; i < fact.result; i++) html += '<div class="dot second"></div>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function toggleDots() {
            dotsEnabled = !dotsEnabled;
            document.getElementById('dotsBtn').classList.toggle('active', dotsEnabled);
            if (currentFact) renderDots(currentFact);
        }

        // ============================================
        // PROFILE MANAGEMENT
        // ============================================
        function loadProfiles() {
            const saved = localStorage.getItem('nanana_profiles');
            profiles = saved ? JSON.parse(saved) : [];
            renderProfiles();
        }

        function saveProfiles() {
            localStorage.setItem('nanana_profiles', JSON.stringify(profiles));
        }

        function renderProfiles() {
            const grid = document.getElementById('profilesGrid');
            grid.innerHTML = '';

            profiles.forEach((profile, index) => {
                const card = document.createElement('div');
                card.className = 'profile-card';
                card.onclick = (e) => {
                    if (!e.target.classList.contains('parent-btn')) {
                        selectProfile(index);
                    }
                };

                const tier = getCurrentTier(profile);
                const streak = calculateStreak(profile);
                const streakHTML = streak > 0 ? `<div class="profile-streak">üî• ${streak} day${streak > 1 ? 's' : ''}</div>` : '';

                card.innerHTML = `
                    <button class="parent-btn" onclick="event.stopPropagation(); showParentView(${index})" title="View progress">üìä</button>
                    <div class="profile-avatar">${profile.avatar}</div>
                    <div class="profile-name">${profile.name}</div>
                    <div class="profile-level">${tier ? tier.name : 'Starting'}</div>
                    ${streakHTML}
                `;
                grid.appendChild(card);
            });

            // Add new profile card
            const addCard = document.createElement('div');
            addCard.className = 'profile-card add-new';
            addCard.onclick = showAddProfile;
            addCard.innerHTML = `
                <div class="profile-avatar">+</div>
                <div class="profile-name">Add Player</div>
            `;
            grid.appendChild(addCard);
        }

        // Calculate consecutive day streak
        function calculateStreak(profile) {
            if (!profile.dailyProgress) return 0;

            const dates = Object.keys(profile.dailyProgress).sort().reverse();
            if (dates.length === 0) return 0;

            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

            // Must have practiced today or yesterday to have an active streak
            if (dates[0] !== today && dates[0] !== yesterday) return 0;

            let streak = 0;
            let checkDate = new Date(dates[0]);

            for (const dateStr of dates) {
                const date = new Date(dateStr);
                const expectedDate = new Date(checkDate);
                expectedDate.setDate(expectedDate.getDate() - streak);

                if (dateStr === expectedDate.toISOString().split('T')[0]) {
                    streak++;
                } else {
                    break;
                }
            }

            return streak;
        }

        function showAddProfile() {
            selectedAvatar = AVATARS[0];
            renderAvatarPicker();
            document.getElementById('nameInput').value = '';
            document.getElementById('addProfileModal').classList.add('active');
        }

        function closeAddProfile() {
            document.getElementById('addProfileModal').classList.remove('active');
        }

        function renderAvatarPicker() {
            const picker = document.getElementById('avatarPicker');
            picker.innerHTML = AVATARS.map(avatar => `
                <div class="avatar-option ${avatar === selectedAvatar ? 'selected' : ''}"
                     onclick="selectAvatar('${avatar}')">${avatar}</div>
            `).join('');
        }

        function selectAvatar(avatar) {
            selectedAvatar = avatar;
            renderAvatarPicker();
        }

        function saveNewProfile() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                document.getElementById('nameInput').focus();
                return;
            }

            const newProfile = {
                id: Date.now(),
                name: name,
                avatar: selectedAvatar,
                currentTierIndex: 0,
                factProgress: {}, // { "3+2": { correct: 5, wrong: 1, lastSeen: timestamp, mastered: true } }
                totalCorrect: 0,
                totalSessions: 0,
                dailyProgress: {} // { "2024-01-15": 12 }
            };

            profiles.push(newProfile);
            saveProfiles();
            closeAddProfile();
            renderProfiles();
        }

        // ============================================
        // PROFILE SELECTION & GAME START
        // ============================================
        function selectProfile(index) {
            currentProfile = profiles[index];
            startPracticeSession();
        }

        function startPracticeSession() {
            // Reset session stats
            sessionStats = { correct: 0, wrong: 0, newlyMastered: [], needsPractice: [] };

            // Update UI
            document.getElementById('currentAvatar').textContent = currentProfile.avatar;
            document.getElementById('currentName').textContent = currentProfile.name;

            updateTierDisplay();
            updateDailyGoal();

            // Show practice screen
            showScreen('practiceScreen');

            // Generate first problem
            generateProblem();
        }

        function getCurrentTier(profile) {
            return TIERS[profile.currentTierIndex] || TIERS[0];
        }

        function getMasteredCount(profile, tier) {
            if (!tier) return 0;
            let count = 0;
            tier.facts.forEach(fact => {
                const key = fact.display;
                const progress = profile.factProgress[key];
                if (progress && progress.mastered) count++;
            });
            return count;
        }

        function updateTierDisplay() {
            const tier = getCurrentTier(currentProfile);
            const mastered = getMasteredCount(currentProfile, tier);
            const total = tier.facts.length;
            const percent = Math.round((mastered / total) * 100);

            document.getElementById('currentTier').textContent = tier.name;
            document.getElementById('tierName').textContent = tier.name;
            document.getElementById('tierCount').textContent = `${mastered}/${total} mastered`;
            document.getElementById('tierFill').style.width = `${percent}%`;
        }

        function updateDailyGoal() {
            const today = new Date().toISOString().split('T')[0];
            const todayProgress = currentProfile.dailyProgress[today] || 0;

            document.getElementById('goalCurrent').textContent = todayProgress;
            document.getElementById('goalTarget').textContent = dailyGoal;
            document.getElementById('goalFill').style.width = `${Math.min(100, (todayProgress / dailyGoal) * 100)}%`;
        }

        // ============================================
        // PROBLEM GENERATION - Smart Selection
        // ============================================
        function generateProblem() {
            const tier = getCurrentTier(currentProfile);
            currentFact = selectSmartFact(tier);

            document.getElementById('problem').textContent = currentFact.display;
            currentInput = '';
            updateAnswerDisplay();
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';
            document.getElementById('answerBox').className = 'answer-box';

            // Audio/Visual aids
            renderDots(currentFact);
            speakProblem(currentFact);
        }

        function selectSmartFact(tier) {
            const facts = tier.facts;
            const learning = [];
            const mastered = [];
            const newFacts = [];

            facts.forEach(fact => {
                const key = fact.display;
                const progress = currentProfile.factProgress[key];

                if (!progress || progress.correct === 0) {
                    newFacts.push(fact);
                } else if (progress.mastered) {
                    mastered.push(fact);
                } else {
                    learning.push(fact);
                }
            });

            // Priority: 70% learning, 20% mastered (review), 10% new
            const rand = Math.random();
            let pool;

            if (rand < 0.7 && learning.length > 0) {
                pool = learning;
            } else if (rand < 0.9 && mastered.length > 0) {
                pool = mastered;
            } else if (newFacts.length > 0) {
                pool = newFacts;
            } else if (learning.length > 0) {
                pool = learning;
            } else {
                pool = mastered.length > 0 ? mastered : facts;
            }

            // Weight by recency and errors
            pool.sort((a, b) => {
                const pa = currentProfile.factProgress[a.display] || { correct: 0, wrong: 0, lastSeen: 0 };
                const pb = currentProfile.factProgress[b.display] || { correct: 0, wrong: 0, lastSeen: 0 };

                // Prioritize facts with more errors
                const errorDiff = pb.wrong - pa.wrong;
                if (errorDiff !== 0) return errorDiff;

                // Then by least recently seen
                return pa.lastSeen - pb.lastSeen;
            });

            // Pick from top 3 with some randomness
            const topN = Math.min(3, pool.length);
            return pool[Math.floor(Math.random() * topN)];
        }

        // ============================================
        // INPUT & ANSWER CHECKING
        // ============================================
        function numPress(num) {
            if (currentInput.length >= 3) return;
            currentInput += num;
            updateAnswerDisplay();
            playSound('tap');
        }

        function clearInput() {
            currentInput = currentInput.slice(0, -1);
            updateAnswerDisplay();
            playSound('tap');
        }

        function updateAnswerDisplay() {
            document.getElementById('answerBox').textContent = currentInput || '|';
        }

        function checkAnswer() {
            if (!currentInput || !currentFact) return;

            const userAnswer = parseInt(currentInput);
            const isCorrect = userAnswer === currentFact.answer;
            const key = currentFact.display;

            // Initialize progress if needed
            if (!currentProfile.factProgress[key]) {
                currentProfile.factProgress[key] = { correct: 0, wrong: 0, lastSeen: 0, mastered: false };
            }

            const progress = currentProfile.factProgress[key];
            progress.lastSeen = Date.now();

            if (isCorrect) {
                handleCorrectAnswer(progress, key);
            } else {
                handleWrongAnswer(progress, key);
            }

            // Update daily progress
            const today = new Date().toISOString().split('T')[0];
            currentProfile.dailyProgress[today] = (currentProfile.dailyProgress[today] || 0) + 1;

            saveProfiles();
            updateTierDisplay();
            updateDailyGoal();

            // Check if daily goal reached
            if (currentProfile.dailyProgress[today] >= dailyGoal) {
                setTimeout(() => showSessionComplete(), 1500);
            } else {
                // Next problem after delay
                setTimeout(generateProblem, isCorrect ? 800 : 2000);
            }
        }

        function handleCorrectAnswer(progress, key) {
            sessionStats.correct++;
            progress.correct++;

            document.getElementById('answerBox').classList.add('correct');
            document.getElementById('feedback').textContent = '‚úì Correct!';
            document.getElementById('feedback').className = 'feedback correct';

            playSound('correct');
            speakFeedback(true);

            // Check for mastery (5 correct with < 20% error rate)
            const errorRate = progress.wrong / (progress.correct + progress.wrong);
            if (!progress.mastered && progress.correct >= 5 && errorRate < 0.2) {
                progress.mastered = true;
                sessionStats.newlyMastered.push(key);
                document.getElementById('feedback').textContent = '‚≠ê Mastered!';
                playSound('mastered');

                // Check for tier advancement
                checkTierAdvancement();
            }
        }

        function handleWrongAnswer(progress, key) {
            sessionStats.wrong++;
            progress.wrong++;

            // If was mastered, might need to un-master with too many errors
            if (progress.mastered) {
                const errorRate = progress.wrong / (progress.correct + progress.wrong);
                if (errorRate > 0.3) {
                    progress.mastered = false;
                }
            }

            if (!sessionStats.needsPractice.includes(key)) {
                sessionStats.needsPractice.push(key);
            }

            document.getElementById('answerBox').classList.add('wrong');
            document.getElementById('feedback').innerHTML = `
                <span class="correct-answer">The answer is ${currentFact.answer}</span>
            `;
            document.getElementById('feedback').className = 'feedback wrong';

            playSound('wrong');
            speakFeedback(false, currentFact.answer);
        }

        function checkTierAdvancement() {
            const tier = getCurrentTier(currentProfile);
            const mastered = getMasteredCount(currentProfile, tier);
            const total = tier.facts.length;
            const masteryRate = mastered / total;

            if (masteryRate >= tier.requiredMastery && currentProfile.currentTierIndex < TIERS.length - 1) {
                currentProfile.currentTierIndex++;
                saveProfiles();

                // Show celebration
                const newTier = getCurrentTier(currentProfile);
                document.getElementById('tierUnlockName').textContent = newTier.name;
                document.getElementById('tierUnlock').classList.add('active');

                setTimeout(() => {
                    document.getElementById('tierUnlock').classList.remove('active');
                    updateTierDisplay();
                }, 3000);
            }
        }

        // ============================================
        // SESSION COMPLETE
        // ============================================
        function showSessionComplete() {
            const total = sessionStats.correct + sessionStats.wrong;
            const accuracy = total > 0 ? Math.round((sessionStats.correct / total) * 100) : 0;

            document.getElementById('sessionCorrect').textContent = sessionStats.correct;
            document.getElementById('sessionAccuracy').textContent = accuracy + '%';

            // Show streak
            const streak = calculateStreak(currentProfile);
            document.getElementById('streakCount').textContent = streak;
            document.getElementById('streakDisplay').style.display = streak > 0 ? 'flex' : 'none';

            // Show mastered facts
            if (sessionStats.newlyMastered.length > 0) {
                document.getElementById('masteredSection').style.display = 'block';
                document.getElementById('masteredFacts').innerHTML = sessionStats.newlyMastered
                    .map(f => `<span class="mastered-fact">${f}</span>`).join('');
            } else {
                document.getElementById('masteredSection').style.display = 'none';
            }

            // Show needs practice
            if (sessionStats.needsPractice.length > 0) {
                document.getElementById('practiceMoreSection').style.display = 'block';
                document.getElementById('practiceFacts').innerHTML = sessionStats.needsPractice
                    .map(f => `<span class="practice-fact">${f}</span>`).join('');
            } else {
                document.getElementById('practiceMoreSection').style.display = 'none';
            }

            showScreen('sessionScreen');
        }

        function continuePractice() {
            // Increase daily goal by 5 and continue
            dailyGoal += 5;
            showScreen('practiceScreen');
            generateProblem();
        }

        // ============================================
        // PARENT VIEW
        // ============================================
        function showParentView(profileIndex) {
            const profile = profiles[profileIndex];
            const tier = getCurrentTier(profile);

            // Player name
            document.getElementById('parentPlayerName').innerHTML = `${profile.avatar} ${profile.name}`;

            // Stats
            const totalProblems = Object.values(profile.dailyProgress || {}).reduce((a, b) => a + b, 0);
            const masteredCount = getMasteredCount(profile, tier);
            const totalFacts = tier.facts.length;
            const streak = calculateStreak(profile);

            document.getElementById('parentStats').innerHTML = `
                <div class="parent-stat">
                    <div class="parent-stat-value">${totalProblems}</div>
                    <div class="parent-stat-label">Total Problems</div>
                </div>
                <div class="parent-stat">
                    <div class="parent-stat-value">${masteredCount}/${totalFacts}</div>
                    <div class="parent-stat-label">Facts Mastered</div>
                </div>
                <div class="parent-stat">
                    <div class="parent-stat-value">${streak}</div>
                    <div class="parent-stat-label">Day Streak</div>
                </div>
                <div class="parent-stat">
                    <div class="parent-stat-value">${tier.name}</div>
                    <div class="parent-stat-label">Current Level</div>
                </div>
            `;

            // Find struggling facts (wrong > 0, sorted by error rate)
            const struggles = [];
            for (const [fact, progress] of Object.entries(profile.factProgress || {})) {
                if (progress.wrong > 0) {
                    const total = progress.correct + progress.wrong;
                    const errorRate = Math.round((progress.wrong / total) * 100);
                    struggles.push({ fact, errorRate, wrong: progress.wrong, correct: progress.correct });
                }
            }
            struggles.sort((a, b) => b.errorRate - a.errorRate);

            if (struggles.length > 0) {
                document.getElementById('parentStruggles').innerHTML = `
                    <div class="parent-struggles-title">‚ö†Ô∏è Needs Practice (${struggles.length} facts)</div>
                    ${struggles.slice(0, 8).map(s => `
                        <div class="struggle-fact">
                            <span>${s.fact}</span>
                            <span class="struggle-rate">${s.errorRate}% errors</span>
                        </div>
                    `).join('')}
                    ${struggles.length > 8 ? `<div style="text-align:center;color:var(--text-dim);margin-top:10px;">+ ${struggles.length - 8} more</div>` : ''}
                `;
                document.getElementById('parentStruggles').style.display = 'block';
            } else {
                document.getElementById('parentStruggles').innerHTML = `
                    <div style="text-align:center;color:var(--success);">‚úì No struggling facts!</div>
                `;
            }

            document.getElementById('parentModal').classList.add('active');
        }

        function closeParentView() {
            document.getElementById('parentModal').classList.remove('active');
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showProfiles() {
            renderProfiles();
            showScreen('profileScreen');
        }

        // ============================================
        // KEYBOARD SUPPORT
        // ============================================
        document.addEventListener('keydown', function(e) {
            if (!document.getElementById('practiceScreen').classList.contains('active')) return;

            if (e.key >= '0' && e.key <= '9') numPress(e.key);
            else if (e.key === 'Backspace') { e.preventDefault(); clearInput(); }
            else if (e.key === 'Enter') checkAnswer();
        });

        // ============================================
        // INIT
        // ============================================
        loadProfiles();
    </script>
</body>
</html>
